<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Syncras ‚Ä¢ Tennis System (Offline)</title>
  <style>
    :root{
      --bg:#0c0a12; --card:#141021; --txt:#f2f1f7; --muted:#b7b3c8;
      --violet:#8b5cf6; --violet2:#a78bfa; --line:#2a2242;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:radial-gradient(1200px 800px at 20% 0%, rgba(139,92,246,.25), transparent 60%),
                 radial-gradient(900px 600px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
                 var(--bg); color:var(--txt);}
    header{padding:18px 18px 10px;border-bottom:1px solid var(--line);position:sticky;top:0;
      backdrop-filter: blur(10px);background:rgba(12,10,18,.72);z-index:10;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,var(--violet),var(--violet2));
      box-shadow:0 8px 30px rgba(139,92,246,.35);}
    h1{margin:0;font-size:16px;font-weight:800}
    .sub{margin:0;color:var(--muted);font-size:12px}
    main{padding:16px;max-width:1200px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr;}}
    .card{background:linear-gradient(180deg, rgba(20,16,33,.92), rgba(20,16,33,.78));
      border:1px solid var(--line);border-radius:16px;padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .card h2{margin:0 0 8px;font-size:14px}
    .card p{margin:6px 0;color:var(--muted);font-size:13px;line-height:1.35}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(167,139,250,.08);font-size:12px;}
    .btn{appearance:none;border:1px solid var(--line);background:rgba(139,92,246,.14);
      color:var(--txt);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700;}
    .btn:hover{border-color:rgba(167,139,250,.55)}
    .btn.primary{background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(167,139,250,.85));border:0;}
    .btn.ghost{background:transparent;}
    input[type="file"], input[type="text"], input[type="number"]{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--txt);outline:none;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:720px){.kpis{grid-template-columns:repeat(4,1fr);}}
    .kpi{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:14px;padding:10px}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:900;margin-top:4px}
    .kpi .s{font-size:11px;color:var(--muted);margin-top:2px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    table{width:100%;border-collapse:collapse;font-size:12px;overflow:hidden;border-radius:14px;border:1px solid var(--line);}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{background:rgba(167,139,250,.08);font-weight:800}
    tr:hover td{background:rgba(255,255,255,.02)}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    canvas{width:100%;height:220px;background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:14px}
    .small{font-size:11px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .notice{padding:10px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Syncras ‚Ä¢ Tennis System (Offline)</h1>
        <p class="sub">Backtest stake=1 ‚Ä¢ quota_nostra ‚Ä¢ valutazione pre-match (informativa)</p>
      </div>
    </div>
    <div class="row">
      <span class="pill">CSV match: <b>Winner,Loser,AvgW,AvgL</b></span>
      <span class="pill">CSV quota: <b>player,win_rate,quota_nostra</b></span>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>1) Carica file e fai backtest</h2>
      <p>
        Puoi caricare <b>uno o pi√π CSV match</b> (es: tennis_matches_2023_2026.csv).
        Se carichi per sbaglio un CSV quota_nostra nel campo match, il tool lo riconosce automaticamente.
      </p>

      <div class="two">
        <div>
          <label>Upload CSV (match e/o quota_nostra)</label>
          <input id="fileAny" type="file" accept=".csv,text/csv" multiple />
          <p class="small">Consigliato: carica <span class="mono">tennis_matches_2023_2026.csv</span>.</p>
        </div>
        <div>
          <label>Stato caricamento</label>
          <div class="notice">
            <div>Match caricati: <b id="stMatches">0</b></div>
            <div>Quota_nostra caricata: <b id="stQuota">0</b></div>
            <div class="small" id="stMsg">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div>
          <h2>Parametri sistema</h2>
          <div class="two">
            <div>
              <label>Quota min</label>
              <input id="pOddsMin" type="number" step="0.01" value="1.25"/>
            </div>
            <div>
              <label>Quota max</label>
              <input id="pOddsMax" type="number" step="0.01" value="1.55"/>
            </div>
          </div>
          <div class="two">
            <div>
              <label>Win rate minimo (ammesso)</label>
              <input id="pWRMin" type="number" step="0.01" value="0.73"/>
            </div>
            <div>
              <label>Match minimi (ammesso)</label>
              <input id="pNMin" type="number" step="1" value="60"/>
            </div>
          </div>
          <div class="two">
            <div>
              <label>Quota avversario min (filtro equilibrio)</label>
              <input id="pOppMin" type="number" step="0.01" value="2.80"/>
            </div>
            <div>
              <label>Soglia giudizio (¬±)</label>
              <input id="pEdgeTh" type="number" step="0.01" value="0.07"/>
            </div>
          </div>
          <p class="small">
            Se ‚ÄúSinner non trovato‚Äù, prova ad abbassare <b>Match minimi</b> (es. 30) o allargare range quota.
            Con filtri stretti, nei tuoi dati entrano pochissimi giocatori.
          </p>
        </div>

        <div>
          <h2>Azioni</h2>
          <button class="btn primary" id="btnRun">Calcola quota_nostra (se manca) + Backtest</button>
          <div style="height:8px"></div>
          <button class="btn" id="btnDownloadQuota">Scarica quota_nostra.csv</button>
          <div class="hr"></div>
          <div class="kpis">
            <div class="kpi">
              <div class="t">Giocate</div>
              <div class="v" id="kBets">‚Äî</div>
              <div class="s">backtest</div>
            </div>
            <div class="kpi">
              <div class="t">Win rate</div>
              <div class="v" id="kWin">‚Äî</div>
              <div class="s">vittorie</div>
            </div>
            <div class="kpi">
              <div class="t">Profitto</div>
              <div class="v" id="kProfit">‚Äî</div>
              <div class="s">stake=1</div>
            </div>
            <div class="kpi">
              <div class="t">Max DD</div>
              <div class="v" id="kDD">‚Äî</div>
              <div class="s">drawdown</div>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Curva bankroll</label>
        <canvas id="bankrollChart" width="1000" height="280"></canvas>
      </div>

      <div class="hr"></div>
      <h2>Dettaglio backtest (prime 200)</h2>
      <div style="overflow:auto; max-height:320px">
        <table id="tblBets">
          <thead>
            <tr>
              <th>#</th><th>Player</th><th>Odds</th><th>Outcome</th><th>Profit</th><th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <aside class="card">
      <h2>2) Valuta quota pre-match</h2>
      <p>Inserisci un giocatore e la quota bookmaker. Se √® in quota_nostra, calcolo quota nostra, scarto e giudizio.</p>

      <label>Giocatore X (come nel dataset: es. ‚ÄúZverev A.‚Äù)</label>
      <input id="inPlayer" type="text" placeholder="Es: Zverev A." />

      <div class="two">
        <div>
          <label>Quota bookmaker su X</label>
          <input id="inOddsX" type="number" step="0.01" placeholder="Es: 1.42" />
        </div>
        <div>
          <label>Quota avversario (opzionale)</label>
          <input id="inOddsOpp" type="number" step="0.01" placeholder="Es: 3.10" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <button class="btn primary" id="btnEval">Valuta</button>
        <button class="btn ghost" id="btnClear">Reset</button>
      </div>

      <div class="hr"></div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Quota nostra</div>
          <div class="v" id="kFair">‚Äî</div>
          <div class="s">1 / win_rate</div>
        </div>
        <div class="kpi">
          <div class="t">Win rate</div>
          <div class="v" id="kWR">‚Äî</div>
          <div class="s">storico</div>
        </div>
        <div class="kpi">
          <div class="t">Scarto</div>
          <div class="v" id="kEdge">‚Äî</div>
          <div class="s">(book-fair)/fair</div>
        </div>
        <div class="kpi">
          <div class="t">Giudizio</div>
          <div class="v" id="kJudge">‚Äî</div>
          <div class="s">üü¢/‚ö™/üî¥</div>
        </div>
      </div>

      <div class="hr"></div>
      <h2>Preview quota_nostra</h2>
      <div style="overflow:auto; max-height:360px">
        <table id="tblQuota">
          <thead><tr><th>Player</th><th>Match</th><th>Win%</th><th>Quota nostra</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </aside>
  </div>
</main>

<script>
/** Robust CSV parser (delimiter auto + quotes support) */
function detectDelimiter(text){
  const comma = (text.match(/,/g)||[]).length;
  const semi  = (text.match(/;/g)||[]).length;
  return semi > comma ? ';' : ',';
}
function parseCSV(text){
  const delim = detectDelimiter(text);
  const rows = [];
  let i = 0, field = "", row = [], inQuotes = false;
  const pushField = () => { row.push(field); field = ""; };
  const pushRow = () => { rows.push(row); row = []; };

  while(i < text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i++; }
        else inQuotes = false;
      } else field += c;
    } else {
      if(c === '"') inQuotes = true;
      else if(c === delim){ pushField(); }
      else if(c === '\n'){ pushField(); pushRow(); }
      else if(c === '\r'){ /* ignore */ }
      else field += c;
    }
    i++;
  }
  if(field.length || row.length){ pushField(); pushRow(); }

  // headers
  const clean = rows.filter(r => r.some(x => String(x).trim() !== ""));
  if(clean.length < 2) return [];
  const headers = clean[0].map(h => String(h).trim());
  const out = [];
  for(let r=1;r<clean.length;r++){
    const obj = {};
    for(let c=0;c<headers.length;c++){
      obj[headers[c]] = (clean[r][c] ?? "").toString().trim();
    }
    out.push(obj);
  }
  return out;
}
function toNum(x){
  if(x===null||x===undefined) return NaN;
  const s = String(x).replace(',', '.').trim();
  const v = Number(s);
  return Number.isFinite(v) ? v : NaN;
}
function fmtPct(x){ return Number.isFinite(x) ? (x*100).toFixed(2)+"%" : "‚Äî"; }
function fmt2(x){ return Number.isFinite(x) ? x.toFixed(2) : "‚Äî"; }
function setText(id,v){ document.getElementById(id).textContent = v; }
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

let MATCHES = [];        // [{Winner,Loser,AvgW,AvgL,Year,Date}]
let QUOTA = [];          // [{player,matches,wins,win_rate,quota_nostra}]
let QUOTA_MAP = new Map();
let LAST_BETS = [];

function normalizeMatchRow(r){
  const Winner = (r.Winner ?? r.winner ?? "").trim();
  const Loser  = (r.Loser  ?? r.loser  ?? "").trim();
  const AvgW   = toNum(r.AvgW ?? r.avgw ?? r.AVGW);
  const AvgL   = toNum(r.AvgL ?? r.avgl ?? r.AVGL);
  const Date   = (r.Date ?? r.date ?? "").trim();
  const Year   = toNum(r.Year ?? r.year);
  if(!Winner || !Loser || !Number.isFinite(AvgW) || !Number.isFinite(AvgL)) return null;
  return {Winner,Loser,AvgW,AvgL,Date,Year:Number.isFinite(Year)?Year:null};
}
function parseQuotaRows(rows){
  const out=[];
  for(const r of rows){
    const player = (r.player ?? r.Player ?? "").trim();
    const matches = toNum(r.matches ?? r.Matches);
    const wins = toNum(r.wins ?? r.Wins);
    const win_rate = toNum(r.win_rate ?? r.WinRate ?? r.winrate);
    const quota_nostra = toNum(r.quota_nostra ?? r.QuotaNostra ?? r.quota);
    if(!player || !Number.isFinite(matches) || !Number.isFinite(win_rate) || !Number.isFinite(quota_nostra)) continue;
    out.push({player,matches,wins:Number.isFinite(wins)?wins:null,win_rate,quota_nostra});
  }
  out.sort((a,b)=>a.quota_nostra-b.quota_nostra);
  return out;
}
function refreshQuotaPreview(){
  const tb = document.querySelector("#tblQuota tbody");
  tb.innerHTML="";
  QUOTA.slice(0,200).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.player}</td><td>${r.matches}</td><td>${fmtPct(r.win_rate)}</td><td>${fmt2(r.quota_nostra)}</td>`;
    tb.appendChild(tr);
  });
}

function buildLong(matches){
  const obs=[];
  for(const m of matches){
    obs.push({player:m.Winner, odds:m.AvgW, outcome:1, oppOdds:m.AvgL});
    obs.push({player:m.Loser,  odds:m.AvgL, outcome:0, oppOdds:m.AvgW});
  }
  return obs;
}
function computeQuotaNostraFromMatches(matches, params){
  const {oddsMin, oddsMax, wrMin, nMin} = params;
  const obs = buildLong(matches).filter(o => o.odds>=oddsMin && o.odds<=oddsMax);
  const agg=new Map();
  for(const o of obs){
    const a=agg.get(o.player)||{matches:0,wins:0};
    a.matches++; a.wins+=o.outcome;
    agg.set(o.player,a);
  }
  const rows=[];
  for(const [player,a] of agg.entries()){
    const wr=a.wins/a.matches;
    if(a.matches>=nMin && wr>=wrMin){
      rows.push({player,matches:a.matches,wins:a.wins,win_rate:wr,quota_nostra:1/wr});
    }
  }
  rows.sort((a,b)=>a.quota_nostra-b.quota_nostra);
  return rows;
}
function runBacktest(matches, params){
  const {oddsMin, oddsMax, oppMin} = params;
  const obs = buildLong(matches).filter(o => o.odds>=oddsMin && o.odds<=oddsMax);
  const bets=[];
  let n=0;
  for(const o of obs){
    const q=QUOTA_MAP.get(o.player);
    if(!q) continue;
    if(Number.isFinite(oppMin) && Number.isFinite(o.oppOdds) && o.oppOdds < oppMin) continue;
    n++;
    const profit=o.outcome*o.odds-1;
    bets.push({n, player:o.player, odds:o.odds, outcome:o.outcome, profit, note:"OK"});
  }
  return bets;
}
function computeKPIs(bets){
  if(!bets.length) return {n:0, win:NaN, profit:0, dd:0, curve:[]};
  let cum=0, peak=0, dd=0, wins=0;
  const curve=[];
  for(const b of bets){
    cum+=b.profit; if(cum>peak) peak=cum;
    dd=Math.max(dd, peak-cum);
    curve.push(cum);
    if(b.outcome===1) wins++;
  }
  return {n:bets.length, win:wins/bets.length, profit:cum, dd, curve};
}
function renderBetsTable(bets){
  const tb=document.querySelector("#tblBets tbody");
  tb.innerHTML="";
  bets.slice(0,200).forEach(b=>{
    const out = b.outcome===1 ? "<span class='ok'>WIN</span>" : "<span class='bad'>LOSS</span>";
    const pc = b.profit>=0 ? "ok" : "bad";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="muted">${b.n}</td><td>${b.player}</td><td>${fmt2(b.odds)}</td><td>${out}</td><td class="${pc}">${fmt2(b.profit)}</td><td class="muted">${b.note}</td>`;
    tb.appendChild(tr);
  });
}
function drawCurve(curve){
  const c=document.getElementById("bankrollChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.strokeStyle="rgba(167,139,250,0.18)";
  for(let i=1;i<=4;i++){ const y=i*c.height/5; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(c.width,y); ctx.stroke(); }
  if(!curve.length){ ctx.fillStyle="rgba(183,179,200,0.8)"; ctx.fillText("Nessun dato.", 16, 26); return; }
  const min=Math.min(...curve), max=Math.max(...curve);
  const pad=18, w=c.width, h=c.height;
  const X=i=>pad+i*(w-2*pad)/(curve.length-1);
  const Y=v=>h-pad-(v-min)*((h-2*pad)/((max-min)||1));
  ctx.lineWidth=2; ctx.strokeStyle="rgba(139,92,246,0.95)";
  ctx.beginPath(); ctx.moveTo(X(0),Y(curve[0]));
  for(let i=1;i<curve.length;i++) ctx.lineTo(X(i),Y(curve[i]));
  ctx.stroke();
  ctx.fillStyle="rgba(242,241,247,0.92)"; ctx.font="12px system-ui";
  ctx.fillText(`min ${min.toFixed(2)} ‚Ä¢ max ${max.toFixed(2)} ‚Ä¢ n ${curve.length}`, 16, 20);
}

async function readFiles(fileList){
  const files=Array.from(fileList||[]);
  const out=[];
  for(const f of files){ out.push({name:f.name, text: await f.text()}); }
  return out;
}

document.getElementById("fileAny").addEventListener("change", async (e)=>{
  const files = e.target.files;
  if(!files || !files.length) return;

  const texts = await readFiles(files);
  let addedMatches=0, addedQuota=0;
  let msgParts=[];

  for(const t of texts){
    const rows=parseCSV(t.text);
    if(!rows.length){ msgParts.push(`${t.name}: vuoto/non valido`); continue; }
    const headers=Object.keys(rows[0]).map(h=>h.toLowerCase());

    const isMatch = headers.includes("winner") && headers.includes("loser") &&
                    headers.includes("avgw") && headers.includes("avgl");
    const isQuota = headers.includes("player") && headers.includes("win_rate") && headers.includes("quota_nostra");

    if(isQuota && !isMatch){
      const q=parseQuotaRows(rows);
      if(q.length){
        QUOTA = QUOTA.concat(q);
        addedQuota += q.length;
        msgParts.push(`${t.name}: quota_nostra (+${q.length})`);
      } else msgParts.push(`${t.name}: quota_nostra ma righe non leggibili`);
      continue;
    }

    // try parse match
    let local=0;
    for(const r of rows){
      const m=normalizeMatchRow(r);
      if(m){ MATCHES.push(m); local++; }
    }
    addedMatches += local;
    msgParts.push(`${t.name}: match (+${local})`);
  }

  // de-dup quota by player (keep best info)
  if(QUOTA.length){
    const map=new Map();
    for(const r of QUOTA){
      const cur=map.get(r.player);
      if(!cur || (r.matches||0) > (cur.matches||0)) map.set(r.player,r);
    }
    QUOTA=[...map.values()].sort((a,b)=>a.quota_nostra-b.quota_nostra);
    QUOTA_MAP=new Map(QUOTA.map(r=>[r.player,r]));
    refreshQuotaPreview();
  }

  setText("stMatches", String(MATCHES.length));
  setText("stQuota", String(QUOTA.length));
  setText("stMsg", msgParts.join(" ‚Ä¢ "));
});

document.getElementById("btnRun").addEventListener("click", ()=>{
  const oddsMin=toNum(document.getElementById("pOddsMin").value);
  const oddsMax=toNum(document.getElementById("pOddsMax").value);
  const wrMin=toNum(document.getElementById("pWRMin").value);
  const nMin=toNum(document.getElementById("pNMin").value);
  const oppMin=toNum(document.getElementById("pOppMin").value);

  if(!MATCHES.length){
    alert("Mancano i match. Carica un CSV match (Winner,Loser,AvgW,AvgL), es: tennis_matches_2023_2026.csv");
    return;
  }

  // If quota not loaded, compute now
  if(!QUOTA.length){
    QUOTA = computeQuotaNostraFromMatches(MATCHES, {oddsMin,oddsMax,wrMin,nMin});
    QUOTA_MAP=new Map(QUOTA.map(r=>[r.player,r]));
    refreshQuotaPreview();
    setText("stQuota", String(QUOTA.length));
    setText("stMsg", "Quota_nostra calcolata dai match.");
  }

  // Backtest
  LAST_BETS = runBacktest(MATCHES, {oddsMin,oddsMax,oppMin});
  const k=computeKPIs(LAST_BETS);
  setText("kBets", String(k.n));
  setText("kWin", fmtPct(k.win));
  setText("kProfit", (k.profit>=0?"+":"") + fmt2(k.profit));
  setText("kDD", "‚àí" + fmt2(k.dd));
  renderBetsTable(LAST_BETS);
  drawCurve(k.curve);
});

document.getElementById("btnDownloadQuota").addEventListener("click", ()=>{
  if(!QUOTA.length){ alert("Nessuna quota_nostra. Premi Calcola/Backtest prima."); return; }
  const lines=["player,matches,wins,win_rate,quota_nostra"];
  QUOTA.forEach(r=>{
    const p = `"${String(r.player).replaceAll('"','""')}"`;
    lines.push([p, r.matches, (r.wins??""), r.win_rate, r.quota_nostra].join(","));
  });
  downloadText("quota_nostra.csv", lines.join("\n"));
});

document.getElementById("btnEval").addEventListener("click", ()=>{
  const player=document.getElementById("inPlayer").value.trim();
  const oddsX=toNum(document.getElementById("inOddsX").value);
  const oddsOpp=toNum(document.getElementById("inOddsOpp").value);
  const oppMin=toNum(document.getElementById("pOppMin").value);
  const edgeTh=toNum(document.getElementById("pEdgeTh").value);

  const q=QUOTA_MAP.get(player);
  if(!q){
    setText("kFair","‚Äî"); setText("kWR","‚Äî"); setText("kEdge","‚Äî");
    setText("kJudge","Giocatore non trovato in quota_nostra");
    return;
  }
  setText("kFair", fmt2(q.quota_nostra));
  setText("kWR", fmtPct(q.win_rate));

  if(!Number.isFinite(oddsX)){
    setText("kEdge","‚Äî"); setText("kJudge","Inserisci quota bookmaker");
    return;
  }
  if(Number.isFinite(oddsOpp) && Number.isFinite(oppMin) && oddsOpp < oppMin){
    setText("kEdge","‚Äî"); setText("kJudge","Scartata: avversario troppo forte (opp<min)");
    return;
  }
  const edge=(oddsX-q.quota_nostra)/q.quota_nostra;
  setText("kEdge", fmtPct(edge));
  let judge="‚ö™ Neutra";
  if(edge>=edgeTh) judge="üü¢ Sottovalutata";
  else if(edge<=-edgeTh) judge="üî¥ Sopravvalutata";
  setText("kJudge", judge);
});

document.getElementById("btnClear").addEventListener("click", ()=>{
  document.getElementById("inPlayer").value="";
  document.getElementById("inOddsX").value="";
  document.getElementById("inOddsOpp").value="";
  setText("kFair","‚Äî"); setText("kWR","‚Äî"); setText("kEdge","‚Äî"); setText("kJudge","‚Äî");
});
</script>
</body>
</html>

