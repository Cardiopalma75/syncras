<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consumi per Stanze ‚Äì Modulo Syncras</title>
  <style>
    :root{
      --violet:#6C5CE7;
      --violet-dark:#4B3ACB;
      --bg:#F7F7FB;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --soft:#f3f4ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    main{
      max-width:980px;margin:16px auto 28px;padding:16px 14px 22px;
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    h1{margin:0 0 8px;color:var(--violet-dark)}
    .sub{margin:0 0 12px;color:var(--muted);font-size:.95rem}

    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;
      padding:12px;border-radius:14px;background:linear-gradient(90deg, rgba(108,92,231,.10), rgba(75,58,203,.08));
      border:1px solid rgba(108,92,231,.22);margin:12px 0 14px;
    }
    .field{display:flex;flex-direction:column;gap:4px;min-width:220px}
    .field label{font-weight:800;font-size:.86rem}
    .field input{
      padding:9px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:1rem;background:#fff;
    }
    .hint{font-size:.82rem;color:var(--muted)}
    .btn{
      border:none;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;
      background:linear-gradient(90deg, var(--violet-dark), var(--violet));color:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn.secondary{
      background:#fff;color:var(--violet-dark);border:2px solid rgba(108,92,231,.55);
      box-shadow:none;
    }
    .btn:active{transform:translateY(1px)}

    .legal{
      margin:10px 0 14px;padding:10px 12px;border-radius:14px;background:#fff;
      border:1px solid var(--border);font-size:.92rem;
    }
    .legal a{color:var(--violet);font-weight:900;text-decoration:underline}
    .badge{
      display:inline-block;padding:3px 9px;border-radius:999px;
      background:rgba(108,92,231,.10);border:1px solid rgba(108,92,231,.25);
      color:#312e81;font-weight:900;font-size:.78rem;letter-spacing:.05em;text-transform:uppercase;
      margin-bottom:8px;
    }

    .section{
      margin-top:14px;padding:14px;border-radius:14px;background:#fff;border:1px solid var(--border);
    }
    .sectionHead{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sectionHead h2{margin:0;color:var(--violet-dark);font-size:1.05rem}
    .sectionHead small{color:var(--muted)}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:.82rem;color:var(--muted);font-weight:900;text-align:left;padding:0 8px}
    td{
      background:#fafafa;border:1px solid #eee;padding:10px 8px;vertical-align:middle;
    }
    tr td:first-child{border-radius:12px 0 0 12px}
    tr td:last-child{border-radius:0 12px 12px 0}

    .nameCell{display:flex;align-items:center;gap:10px;font-weight:900}
    .icon{
      width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
      background:var(--soft);border:1px solid rgba(108,92,231,.18);font-size:18px;
    }
    .mini{font-size:.8rem;color:var(--muted);font-weight:700;margin-top:2px}

    .rowInput, .rowSelect{
      width:100%;padding:8px 9px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-size:.95rem;
    }
    .rowSelect{font-weight:800}
    .costCell{font-weight:900;white-space:nowrap}
    .mutedCost{display:block;font-size:.8rem;color:var(--muted);font-weight:700;margin-top:3px}

    .toggleBox{
      margin-top:12px;padding:12px;border-radius:14px;background:#f3f4ff;border:1px solid rgba(108,92,231,.25);
    }
    .toggleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .advanced{display:none;margin-top:12px}

    .results{
      margin-top:16px;padding:14px;border-radius:14px;
      border:1px solid rgba(108,92,231,.25);
      background:linear-gradient(90deg, rgba(108,92,231,.10), rgba(75,58,203,.08));
      display:none;
    }
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;align-items:center}
    .bigNum{font-size:1.25rem;font-weight:900}
    .pills{margin-top:8px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      background:#fff;border:1px solid rgba(108,92,231,.25);font-weight:900;margin:6px 6px 0 0;
    }
    canvas{
      width:100%;max-width:360px;height:auto;background:#fff;
      border:1px solid rgba(108,92,231,.20);border-radius:14px;padding:6px;
    }
    .shareBox{margin-top:12px;padding:12px;border-radius:14px;background:#fff;border:1px solid rgba(108,92,231,.22)}
    .shareText{
      width:100%;min-height:96px;resize:vertical;border-radius:12px;border:1px solid #d1d5db;padding:10px;font-size:.92rem;
    }

    @media (max-width: 840px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>

<body>
<main>
  <span class="badge">Calcolatore per stanze</span>
  <h1>Consumi di casa: chi ti svuota la bolletta? ‚ö°</h1>
  <p class="sub">Diviso per stanze (Cucina / Salotto / Bagno / Clima). Costo per riga in tempo reale + risultato condivisibile.</p>

  <div class="topbar">
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <div class="field">
        <label for="priceKwh">Prezzo energia (‚Ç¨/kWh)</label>
        <input id="priceKwh" type="number" step="0.01" min="0.05" max="2" value="0.30" />
        <div class="hint">Metti il tuo valore reale (es. 0,28 / 0,35)</div>
      </div>

      <div class="field">
        <label for="daysMonth">Giorni nel mese</label>
        <input id="daysMonth" type="number" min="28" max="31" value="30" />
        <div class="hint">Per i dispositivi ‚Äúa ore/giorno‚Äù</div>
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn secondary" id="resetBtn" type="button">‚Ü∫ Reset</button>
      <button class="btn" id="calcBtn" type="button">üìä Calcola & Grafico</button>
    </div>
  </div>

  <div class="legal">
    <label style="display:flex; gap:10px; align-items:flex-start;">
      <input type="checkbox" id="legalAccept" style="margin-top:4px;">
      <span>
        Risultati = <strong>stime indicative</strong>. Dettagli nelle
        <a href="note-legali.html" target="_blank" rel="noopener">Note Legali</a>.
        <span style="display:block; margin-top:6px; color:var(--muted); font-size:.82rem;">
          Serve per capire cosa pesa davvero, non √® consulenza professionale.
        </span>
      </span>
    </label>
  </div>

  <!-- ================== CUCINA ================== -->
  <section class="section">
    <div class="sectionHead">
      <h2>üç≥ Cucina (il cuore dei consumi)</h2>
      <small>Grandi consumatori + uso reale</small>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:34%">Prodotto</th>
          <th style="width:18%">W / kWh</th>
          <th style="width:18%">Uso</th>
          <th style="width:30%">Costo stimato</th>
        </tr>
      </thead>
      <tbody>
        <tr data-type="power" data-room="Cucina" data-name="Frigorifero">
          <td>
            <div class="nameCell"><div class="icon">üßä</div>
              <div>Frigorifero / Congelatore<div class="mini">Ciclico (24h)</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="10" max="300" value="70"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="24"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Cucina" data-name="Forno elettrico">
          <td>
            <div class="nameCell"><div class="icon">üî•</div>
              <div>Forno elettrico<div class="mini">Cotture settimanali</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="500" max="3500" value="2200"></td>
          <td>
            <input class="rowInput ovenHours" type="number" min="0" max="6" step="0.25" value="1">
            <div class="mini">ore/cottura</div>
            <input class="rowInput ovenPerW" type="number" min="0" max="21" step="1" value="3" style="margin-top:6px">
            <div class="mini">cotture/settimana</div>
          </td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="cycle" data-room="Cucina" data-name="Lavastoviglie">
          <td>
            <div class="nameCell"><div class="icon">üçΩÔ∏è</div>
              <div>Lavastoviglie<div class="mini">kWh per ciclo</div></div>
            </div>
          </td>
          <td>
            <input class="rowInput kwhCycle" type="number" min="0" max="5" step="0.1" value="1.0">
            <div class="mini">kWh/ciclo</div>
          </td>
          <td>
            <input class="rowInput cyclesW" type="number" min="0" max="21" step="1" value="5">
            <div class="mini">cicli/settimana</div>
          </td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Cucina" data-name="Induzione/Microonde" data-alt="1">
          <td>
            <div class="nameCell"><div class="icon">‚ö°</div>
              <div>Cottura rapida<div class="mini">Induzione o Microonde</div></div>
            </div>
          </td>
          <td>
            <select class="rowSelect altSelect">
              <option value="1800">Induzione (1 fuoco) ~ 1800 W</option>
              <option value="1000">Microonde ~ 1000 W</option>
              <option value="2000">Bollitore ~ 2000 W</option>
            </select>
          </td>
          <td><input class="rowInput hours" type="number" min="0" max="6" step="0.05" value="0.5"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- ================== BAGNO/LAVANDERIA ================== -->
  <section class="section">
    <div class="sectionHead">
      <h2>üöø Lavanderia & Bagno (picchi di potenza)</h2>
      <small>Quelli che ‚Äúsaltano il contatore‚Äù se li accendi insieme</small>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:34%">Prodotto</th>
          <th style="width:18%">W / kWh</th>
          <th style="width:18%">Uso</th>
          <th style="width:30%">Costo stimato</th>
        </tr>
      </thead>
      <tbody>
        <tr data-type="cycle" data-room="Bagno/Lavanderia" data-name="Lavatrice">
          <td>
            <div class="nameCell"><div class="icon">üëï</div>
              <div>Lavatrice<div class="mini">kWh per ciclo</div></div>
            </div>
          </td>
          <td>
            <input class="rowInput kwhCycle" type="number" min="0" max="5" step="0.1" value="1.0">
            <div class="mini">kWh/ciclo</div>
          </td>
          <td>
            <input class="rowInput cyclesW" type="number" min="0" max="30" step="1" value="5">
            <div class="mini">lavaggi/settimana</div>
          </td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="cycle" data-room="Bagno/Lavanderia" data-name="Asciugatrice" data-dryer="1">
          <td>
            <div class="nameCell"><div class="icon">üå™Ô∏è</div>
              <div>Asciugatrice<div class="mini">Seleziona tipo</div></div>
            </div>
          </td>
          <td>
            <select class="rowSelect dryerPreset">
              <option value="2.0">Pompa di calore ~ 2,0 kWh/ciclo</option>
              <option value="3.5">Resistenza ~ 3,5 kWh/ciclo</option>
            </select>
          </td>
          <td>
            <input class="rowInput cyclesW" type="number" min="0" max="21" step="1" value="4">
            <div class="mini">cicli/settimana</div>
          </td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Bagno/Lavanderia" data-name="Scaldabagno elettrico">
          <td>
            <div class="nameCell"><div class="icon">üöø</div>
              <div>Scaldabagno elettrico<div class="mini">se lo usi davvero</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="3000" value="0"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="0"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Bagno/Lavanderia" data-name="Phon">
          <td>
            <div class="nameCell"><div class="icon">üí®</div>
              <div>Phon<div class="mini">alta potenza, poco tempo</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="3000" value="2000"></td>
          <td><input class="rowInput hours" type="number" min="0" max="3" step="0.05" value="0.17"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- ================== SOGGIORNO / HOME OFFICE ================== -->
  <section class="section">
    <div class="sectionHead">
      <h2>üõãÔ∏è Soggiorno & Home Office (vampiri costanti)</h2>
      <small>Quelli che rubano soldi perch√© restano accesi ore e ore</small>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:34%">Prodotto</th>
          <th style="width:18%">W</th>
          <th style="width:18%">Ore/giorno</th>
          <th style="width:30%">Costo stimato</th>
        </tr>
      </thead>
      <tbody>
        <tr data-type="power" data-room="Soggiorno/Office" data-name="TV">
          <td>
            <div class="nameCell"><div class="icon">üì∫</div>
              <div>Televisore<div class="mini">LED/OLED medio</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="600" value="120"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="4"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Soggiorno/Office" data-name="Decoder / Box TV">
          <td>
            <div class="nameCell"><div class="icon">üì¶</div>
              <div>Decoder / Box TV<div class="mini">spesso resta 24h</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="200" value="20"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="24"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Soggiorno/Office" data-name="Console PS5/Xbox">
          <td>
            <div class="nameCell"><div class="icon">üéÆ</div>
              <div>Console (PS5 / Xbox)<div class="mini">se giochi 1-2 ore al giorno</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="800" value="180"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="1"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Soggiorno/Office" data-name="PC/Laptop" data-pc="1">
          <td>
            <div class="nameCell"><div class="icon">üñ•Ô∏è</div>
              <div>Computer<div class="mini">PC fisso o Laptop</div></div>
            </div>
          </td>
          <td>
            <select class="rowSelect pcPreset">
              <option value="400">PC fisso (medio) ~ 400 W</option>
              <option value="60">Laptop ~ 60 W</option>
            </select>
          </td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="3"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Soggiorno/Office" data-name="Modem/Router">
          <td>
            <div class="nameCell"><div class="icon">üåê</div>
              <div>Modem + Router<div class="mini">Sempre acceso (24h)</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="80" value="15"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="24"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>
      </tbody>
    </table>

    <div class="toggleBox">
      <div class="toggleRow">
        <div>
          <strong>üßõ Aggiungi ‚Äústandby & vampiri‚Äù extra</strong>
          <div class="hint">Caricatori, lucine, ciabatte, ecc. (quelli che sorprendono).</div>
        </div>
        <button class="btn secondary" type="button" id="toggleAdvanced">Mostra extra</button>
      </div>

      <div class="advanced" id="advancedBlock">
        <table>
          <thead>
            <tr>
              <th style="width:34%">Prodotto</th>
              <th style="width:18%">W</th>
              <th style="width:18%">Ore/giorno</th>
              <th style="width:30%">Costo stimato</th>
            </tr>
          </thead>
          <tbody>
            <tr data-type="power" data-room="Extra Standby" data-name="Standby generico (somma)">
              <td>
                <div class="nameCell"><div class="icon">üîå</div>
                  <div>Standby generico<div class="mini">alimentatori, lucine, ecc.</div></div>
                </div>
              </td>
              <td><input class="rowInput watt" type="number" min="0" max="300" value="15"></td>
              <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="24"></td>
              <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
            </tr>

            <tr data-type="power" data-room="Extra Standby" data-name="Caricabatterie sempre attaccati">
              <td>
                <div class="nameCell"><div class="icon">üîã</div>
                  <div>Caricabatterie<div class="mini">sempre nella presa</div></div>
                </div>
              </td>
              <td><input class="rowInput watt" type="number" min="0" max="100" value="5"></td>
              <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="24"></td>
              <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================== CLIMA ================== -->
  <section class="section">
    <div class="sectionHead">
      <h2>‚ùÑÔ∏èüî• Climatizzazione (stagionale)</h2>
      <small>Qui pesa tantissimo il numero di ore</small>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:34%">Prodotto</th>
          <th style="width:18%">W</th>
          <th style="width:18%">Ore/giorno</th>
          <th style="width:30%">Costo stimato</th>
        </tr>
      </thead>
      <tbody>
        <tr data-type="power" data-room="Clima" data-name="Condizionatore inverter">
          <td>
            <div class="nameCell"><div class="icon">‚ùÑÔ∏è</div>
              <div>Condizionatore (inverter)<div class="mini">media a regime</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="3000" value="800"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="2"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Clima" data-name="Stufetta/Termoventilatore">
          <td>
            <div class="nameCell"><div class="icon">üî•</div>
              <div>Stufetta / Termoventilatore<div class="mini">se la usi poco, metti poco</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="3000" value="0"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="0"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>

        <tr data-type="power" data-room="Clima" data-name="Ventilatore">
          <td>
            <div class="nameCell"><div class="icon">üåÄ</div>
              <div>Ventilatore<div class="mini">poca potenza, tante ore</div></div>
            </div>
          </td>
          <td><input class="rowInput watt" type="number" min="0" max="200" value="50"></td>
          <td><input class="rowInput hours" type="number" min="0" max="24" step="0.25" value="0"></td>
          <td class="costCell"><span class="cost">‚Äî</span><span class="mutedCost">‚âà al mese</span></td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- ================== RISULTATI ================== -->
  <section class="results" id="results">
    <h2 style="margin:0 0 8px;color:var(--violet-dark)">üìç Risultato (condivisibile)</h2>

    <div class="grid2">
      <div>
        <div class="bigNum">Totale stimato: <span id="totalMonth">‚Äî</span> / mese</div>
        <div class="hint" style="margin-top:6px;">Percentuali per stanza (grafico) + top 3 ‚Äúcolpevoli‚Äù.</div>

        <div class="pills" id="pills"></div>

        <div class="shareBox">
          <div style="font-weight:900; margin-bottom:8px;">üì§ Condividi</div>
          <textarea id="shareText" class="shareText" readonly></textarea>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn" type="button" id="copyBtn">üìé Copia testo</button>
            <button class="btn secondary" type="button" id="shareBtn">üì≤ Condividi risultato</button>
          </div>

          <div class="hint" style="margin-top:8px;">
            Se sei su Android/iPhone, ‚ÄúCondividi risultato‚Äù apre WhatsApp/Telegram ecc.
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:center;">
        <canvas id="pie" width="360" height="360"></canvas>
      </div>
    </div>
  </section>
</main>

<script>
  // ===== Helpers =====
  function euro(n){
    if (!isFinite(n)) return "‚Äî";
    return n.toFixed(2).replace(".", ",") + " ‚Ç¨";
  }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  const priceEl = document.getElementById("priceKwh");
  const daysEl  = document.getElementById("daysMonth");
  const legalEl = document.getElementById("legalAccept");

  const toggleBtn = document.getElementById("toggleAdvanced");
  const advancedBlock = document.getElementById("advancedBlock");

  const calcBtn = document.getElementById("calcBtn");
  const resetBtn = document.getElementById("resetBtn");

  const resultsBox = document.getElementById("results");
  const totalMonthEl = document.getElementById("totalMonth");
  const pillsEl = document.getElementById("pills");

  const shareTextEl = document.getElementById("shareText");
  const copyBtn = document.getElementById("copyBtn");
  const shareBtn = document.getElementById("shareBtn");

  // Colori per stanze
  const COLORS = {
    "Cucina": "#ef4444",
    "Bagno/Lavanderia": "#f59e0b",
    "Soggiorno/Office": "#3b82f6",
    "Clima": "#6C5CE7",
    "Extra Standby": "#374151"
  };

  function isRowVisible(tr){
    if (advancedBlock.contains(tr) && advancedBlock.style.display !== "block") return false;
    return true;
  }

  function getRows(){
    return Array.from(document.querySelectorAll("tr[data-type]")).filter(isRowVisible);
  }

  // Calcoli:
  // - power standard: W/1000 * ore/giorno * giorni * prezzo
  // - oven: W/1000 * ore/cottura * cotture/settimana*4 * prezzo * 0.7
  // - cycle: kWh/ciclo * cicli/settimana*4 * prezzo
  function rowMonthlyCost(tr, price, days){
    const type = tr.dataset.type;

    // Forno speciale
    if (tr.dataset.name === "Forno elettrico"){
      let watt = parseFloat(tr.querySelector(".watt")?.value) || 0;
      const h = parseFloat(tr.querySelector(".ovenHours")?.value) || 0;
      const perW = parseFloat(tr.querySelector(".ovenPerW")?.value) || 0;
      watt = clamp(watt, 0, 999999);
      const kwhMonth = (watt/1000) * h * (perW*4) * 0.7;
      return kwhMonth * price;
    }

    if (type === "power"){
      let watt = 0;
      const altSel = tr.querySelector(".altSelect");
      const pcSel  = tr.querySelector(".pcPreset");
      if (altSel) watt = parseFloat(altSel.value) || 0;
      else if (pcSel) watt = parseFloat(pcSel.value) || 0;
      else watt = parseFloat(tr.querySelector(".watt")?.value) || 0;

      const hours = parseFloat(tr.querySelector(".hours")?.value) || 0;
      watt = clamp(watt, 0, 999999);
      const kwhMonth = (watt/1000) * hours * days;
      return kwhMonth * price;
    }

    if (type === "cycle"){
      const dryerPreset = tr.querySelector(".dryerPreset");
      const kwhCycle = dryerPreset ? (parseFloat(dryerPreset.value) || 0) : (parseFloat(tr.querySelector(".kwhCycle")?.value) || 0);
      const cyclesW  = parseFloat(tr.querySelector(".cyclesW")?.value) || 0;
      const kwhMonth = kwhCycle * cyclesW * 4;
      return kwhMonth * price;
    }

    return 0;
  }

  function updateLiveCosts(){
    const price = parseFloat(priceEl.value) || 0;
    const days  = parseFloat(daysEl.value) || 30;

    getRows().forEach(tr => {
      const cost = rowMonthlyCost(tr, price, days);
      const span = tr.querySelector(".cost");
      if (span) span.textContent = euro(cost);
    });
  }

  function checkLegal(){
    if (!legalEl.checked){
      alert("Per usare il simulatore devi dichiarare di aver letto e accettato le Note Legali.");
      return false;
    }
    return true;
  }

  function drawPie(byRoom){
    const canvas = document.getElementById("pie");
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.38;

    ctx.clearRect(0,0,w,h);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,w,h);

    const total = Object.values(byRoom).reduce((a,b)=>a+b,0) || 1;
    let start = -Math.PI/2;

    Object.entries(byRoom).forEach(([room,val]) => {
      const ang = (val/total)*Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+ang);
      ctx.closePath();
      ctx.fillStyle = COLORS[room] || "#9ca3af";
      ctx.fill();
      start += ang;
    });

    // donut
    ctx.beginPath();
    ctx.arc(cx,cy,r*0.58,0,Math.PI*2);
    ctx.fillStyle="#fff";
    ctx.fill();

    ctx.fillStyle="#111827";
    ctx.font="900 18px Arial";
    ctx.textAlign="center";
    ctx.fillText("Totale/mese", cx, cy-6);
    ctx.font="900 22px Arial";
    ctx.fillText(totalMonthEl.textContent.replace(" / mese",""), cx, cy+22);
  }

  function buildResults(){
    const price = parseFloat(priceEl.value) || 0;
    const days  = parseFloat(daysEl.value) || 30;

    const rows = getRows();
    let total = 0;

    const byRoom = {};
    const byDevice = []; // per top 3

    rows.forEach(tr => {
      const room = tr.dataset.room || "Altro";
      const name = tr.dataset.name || "Dispositivo";
      const cost = rowMonthlyCost(tr, price, days);

      total += cost;
      byRoom[room] = (byRoom[room] || 0) + cost;
      byDevice.push({ room, name, cost });
    });

    totalMonthEl.textContent = euro(total) + " / mese";

    // pills percentuali (stanze)
    const sum = Object.values(byRoom).reduce((a,b)=>a+b,0) || 1;
    pillsEl.innerHTML = "";

    Object.entries(byRoom)
      .sort((a,b)=>b[1]-a[1])
      .forEach(([room,val]) => {
        const pct = Math.round((val/sum)*100);
        const pill = document.createElement("div");
        pill.className="pill";
        const dot = document.createElement("span");
        dot.style.width="10px";
        dot.style.height="10px";
        dot.style.borderRadius="999px";
        dot.style.display="inline-block";
        dot.style.background = COLORS[room] || "#9ca3af";
        pill.appendChild(dot);
        pill.appendChild(document.createTextNode(`${room}: ${pct}%`));
        pillsEl.appendChild(pill);
      });

    // Top 3 dispositivi
    byDevice.sort((a,b)=>b.cost-a.cost);
    const top3 = byDevice.slice(0,3).filter(x=>x.cost>0.001);

    const topText = top3.length
      ? top3.map((x,i)=>`${i+1}) ${x.name} (${x.room}) ‚âà ${euro(x.cost)}/mese`).join("\n")
      : "Top 3: (nessun consumo significativo inserito)";

    // Testo condivisibile (con link placeholder)
    const url = "https://syncras.app/calcolatore-consumi-elettrodomestici.html"; // poi lo lasci cos√¨ nella definitiva
    shareTextEl.value =
`Ho fatto il test dei consumi per stanze ‚ö°
Totale stimato: ${euro(total)}/mese

Top 3 ‚Äúcolpevoli‚Äù:
${topText}

Se vuoi provarlo:
üëâ ${url}`;

    drawPie(byRoom);
    resultsBox.style.display="block";
    resultsBox.scrollIntoView({behavior:"smooth", block:"start"});
  }

  // ===== Eventi =====
  function bindLive(){
    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("input", updateLiveCosts);
      el.addEventListener("change", updateLiveCosts);
    });
  }

  toggleBtn.addEventListener("click", () => {
    const open = advancedBlock.style.display === "block";
    advancedBlock.style.display = open ? "none" : "block";
    toggleBtn.textContent = open ? "Mostra extra" : "Nascondi extra";
    updateLiveCosts();
  });

  calcBtn.addEventListener("click", () => {
    if (!checkLegal()) return;
    updateLiveCosts();
    buildResults();
  });

  resetBtn.addEventListener("click", () => location.reload());

  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(shareTextEl.value);
      alert("Testo copiato ‚úÖ");
    }catch(e){
      alert("Copia automatica non disponibile: seleziona il testo e copia manualmente.");
    }
  });

  shareBtn.addEventListener("click", async () => {
    const text = shareTextEl.value;
    if (navigator.share){
      try{ await navigator.share({ text }); }catch(e){}
    }else{
      // fallback: copia negli appunti
      try{
        await navigator.clipboard.writeText(text);
        alert("Il tuo browser non supporta la condivisione diretta: testo copiato ‚úÖ (incolla su WhatsApp).");
      }catch(e){
        alert("Condivisione non supportata: copia manualmente il testo.");
      }
    }
  });

  // init
  bindLive();
  updateLiveCosts();
</script>
</body>
</html>


