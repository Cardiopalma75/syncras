<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Syncras Pro v4.4 - Multi-League Optimizer</title>
  <style>
    :root{--violet:#6C5CE7;--bg:#f0f2f5;--card:#fff;--border:#d1d5db;--text:#1f2937;--success:#10b981;--danger:#ef4444;--bet:#facc15}
    body{font-family:system-ui,sans-serif;margin:20px;background:var(--bg);color:var(--text);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .grid-header{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
    button{cursor:pointer;background:var(--violet);color:#fff;border:0;font-weight:700;padding:12px;border-radius:8px;transition:0.2s;width:100%}
    input, .th-input{padding:5px;border:1px solid var(--border);border-radius:4px;width:60px;text-align:center;font-weight:bold}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
    th{background:#f9fafb;font-size:10px;color:#6b7280;text-transform:uppercase}
    .stat-val{font-size:22px;font-weight:800;display:block;margin-top:5px}
    .profit-pos{color:var(--success)}
    .profit-neg{color:var(--danger)}
    .badge-lg{padding:3px 7px;border-radius:4px;font-weight:bold;background:#374151;color:white;font-size:10px}
  </style>
</head>
<body>

<div class="card">
  <h3>‚öôÔ∏è Impostazioni Globali</h3>
  <div class="grid-header">
    <div><label>Quota Media</label><input type="number" id="avgQuota" value="1.70" step="0.05" style="width:100%"></div>
    <div><label>Stake per Bet (‚Ç¨)</label><input type="number" id="stake" value="10" style="width:100%"></div>
    <div style="display:flex;align-items:flex-end"><button onclick="elabora()">1. CARICA E ANALIZZA</button></div>
  </div>
</div>

<div class="grid-header" id="dash" style="display:none">
  <div class="card"><span>Profitto Totale</span><span id="totProfit" class="stat-val">0.00 u.</span></div>
  <div class="card"><span>Win Rate</span><span id="winRate" class="stat-val" style="color:var(--violet)">0%</span></div>
  <div class="card"><span>Netto (‚Ç¨)</span><span id="totCash" class="stat-val" style="color:#2563eb">0.00 ‚Ç¨</span></div>
  <div class="card"><span>Scommesse</span><span id="winLoss" class="stat-val" style="font-size:14px">0 V / 0 P</span></div>
</div>

<div class="card" id="leaguePanel" style="display:none">
  <h3>üìä Ottimizzatore Leghe (Soglie Individuali)</h3>
  <p style="font-size:11px; color:gray">Modifica la soglia di ogni lega e premi "APPLICA SOGLIE" per aggiornare i risultati.</p>
  <div id="leagueTable"></div>
  <button onclick="updateCalculations()" style="margin-top:15px; background:black">2. APPLICA SOGLIE E RICALCOLA</button>
</div>

<div class="card">
  <h3>üìÇ Caricamento File</h3>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
    <input id="fRes" type="file">
    <input id="fQuo" type="file">
  </div>
  <div id="output" style="margin-top:15px; max-height:400px; overflow-y:auto"></div>
</div>

<script>
let globalRes = [], globalQuo = [], leagueMap = {}, customThresholds = {};

function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    return lines.slice(1).map(line => {
        const cols = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h] = cols[i]);
        return obj;
    });
}

function getRecentStats(team, allResults, currentDate) {
    const history = allResults
        .filter(r => (r.home_team === team || r.away_team === team) && new Date(r.date) < new Date(currentDate))
        .sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
    if (history.length < 5) return null;
    let gf = 0, ga = 0;
    history.forEach(r => {
        const isH = r.home_team === team;
        gf += isH ? parseFloat(r.fthg) : parseFloat(r.ftag);
        ga += isH ? parseFloat(r.ftag) : parseFloat(r.fthg);
    });
    return { avgF: gf/10, avgS: ga/10 };
}

async function elabora() {
    const resFile = document.getElementById('fRes').files[0];
    const quoFile = document.getElementById('fQuo').files[0];
    if(!resFile || !quoFile) return alert("Carica i file!");

    globalRes = parseCSV(await resFile.text());
    globalQuo = parseCSV(await quoFile.text());
    
    // Identifica le leghe e imposta soglia default 60
    globalRes.forEach(r => { 
        if(r.league) {
            leagueMap[r.home_team] = r.league;
            if(!customThresholds[r.league]) customThresholds[r.league] = 60;
        } 
    });

    updateCalculations();
    document.getElementById('dash').style.display = "grid";
    document.getElementById('leaguePanel').style.display = "block";
}

function updateCalculations() {
    // Leggi soglie aggiornate dalla tabella
    document.querySelectorAll('.th-input').forEach(input => {
        customThresholds[input.dataset.lg] = parseFloat(input.value);
    });

    const quota = parseFloat(document.getElementById('avgQuota').value);
    const stake = parseFloat(document.getElementById('stake').value);

    let main = { bets: 0, hits: 0, profit: 0 };
    let leagueStats = {};
    let tableHtml = `<table><thead><tr><th>Match</th><th>Lega</th><th>Prob</th><th>Azione</th></tr></thead><tbody>`;

    globalQuo.forEach(q => {
        const hS = getRecentStats(q.home_team, globalRes, q.date);
        const aS = getRecentStats(q.away_team, globalRes, q.date);
        if(!hS || !aS) return;

        const lg = leagueMap[q.home_team] || "N/A";
        const th = (customThresholds[lg] || 60) / 100;
        
        const mu = (hS.avgF + aS.avgS + aS.avgF + hS.avgS) / 2;
        let prob = 0.50 + (mu - 2.5) * 0.18;
        if(parseFloat(q.b365_x) > 3.70) prob += 0.05;

        if(prob >= th) {
            if(!leagueStats[lg]) leagueStats[lg] = { bets:0, hits:0, profit:0 };
            main.bets++;
            leagueStats[lg].bets++;
            
            const matchR = globalRes.find(r => r.home_team === q.home_team && r.date === q.date);
            let resStr = "üöÄ FUTURA";
            if(matchR) {
                const win = (parseFloat(matchR.fthg) + parseFloat(matchR.ftag)) > 2.5;
                if(win) { 
                    main.hits++; leagueStats[lg].hits++; main.profit += (quota - 1); leagueStats[lg].profit += (quota - 1);
                    resStr = "<b class='profit-pos'>HIT</b>"; 
                } else { 
                    main.profit -= 1; leagueStats[lg].profit -= 1;
                    resStr = "<b class='profit-neg'>MISS</b>"; 
                }
            }
            tableHtml += `<tr><td>${q.home_team}-${q.away_team}</td><td><span class="badge-lg">${lg}</span></td><td>${(prob*100).toFixed(0)}%</td><td>${resStr}</td></tr>`;
        }
    });

    // Tabella Leghe
    let lHtml = "<table><tr><th>Lega</th><th>Soglia %</th><th>Bet</th><th>Win%</th><th>Profitto (u)</th></tr>";
    Object.keys(customThresholds).sort().forEach(l => {
        const s = leagueStats[l] || {bets:0, hits:0, profit:0};
        const wr = s.bets > 0 ? ((s.hits/s.bets)*100).toFixed(1) : 0;
        lHtml += `<tr>
            <td><b>${l}</b></td>
            <td><input type="number" class="th-input" data-lg="${l}" value="${customThresholds[l]}"></td>
            <td>${s.bets}</td>
            <td>${wr}%</td>
            <td class="${s.profit >= 0 ? 'profit-pos' : 'profit-neg'}"><b>${s.profit.toFixed(2)}</b></td>
        </tr>`;
    });
    
    document.getElementById('leagueTable').innerHTML = lHtml + "</table>";
    document.getElementById('winRate').innerText = main.bets > 0 ? (main.hits/main.bets*100).toFixed(1) + "%" : "0%";
    document.getElementById('totProfit').innerText = main.profit.toFixed(2) + " u.";
    document.getElementById('totProfit').className = "stat-val " + (main.profit >=0 ? "profit-pos" : "profit-neg");
    document.getElementById('totCash').innerText = (main.profit * stake).toFixed(2) + " ‚Ç¨";
    document.getElementById('winLoss').innerText = `${main.hits} V / ${main.bets - main.hits} P`;
    document.getElementById('output').innerHTML = tableHtml + "</tbody></table>";
}
</script>
</body>
</html>
