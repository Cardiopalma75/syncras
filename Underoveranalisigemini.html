
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Syncras Pro - Ultra Optimizer V3</title>
  <style>
    :root{--violet:#6C5CE7;--bg:#f7f7fb;--card:#fff;--border:#e7e7f5;--text:#111827;--success:#10b981;--danger:#ef4444}
    body{font-family:system-ui,sans-serif;margin:18px;background:var(--bg);color:var(--text);font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
    .math-dash{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}
    .math-card{background:#f8fafc;padding:12px;border-radius:10px;border:1px solid var(--border);text-align:center}
    .math-val{font-size:20px;font-weight:900;display:block;color:var(--violet)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
    th{background:#f9fafb;color:#666;text-transform:uppercase;font-size:10px}
    button{background:var(--violet);color:white;border:0;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer;width:100%}
    .cfg-input{width:50px;padding:4px;border:1px solid #ddd;border-radius:4px}
    .pos{color:var(--success);font-weight:bold}
    .neg{color:var(--danger);font-weight:bold}
    .badge-count{background:#eee;padding:2px 6px;border-radius:4px;font-weight:bold;font-size:10px}
  </style>
</head>
<body>

  <div class="card">
    <h2 style="margin-top:0">Syncras Pro – Gestione Totale</h2>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; align-items:end">
        <div><label>CSV Risultati</label><br><input id="fRes" type="file"></div>
        <div><label>CSV Quote</label><br><input id="fQuo" type="file"></div>
        <button onclick="caricaDati()">1. CARICA E MAPPA LEGHE</button>
    </div>
  </div>

  <div id="setupLega" class="card" style="display:none">
    <h3>⚙️ 2. Imposta Soglie e Stake per Lega</h3>
    <div id="leagueGrid"></div>
    <br>
    <button onclick="eseguiBacktest()" style="background:#111827">3. AVVIA BACKTEST ANALITICO</button>
  </div>

  <div id="dashboard" class="card" style="display:none; border:2px solid var(--violet)">
    <div class="math-dash">
        <div class="math-card"><span>Bet Totali</span><span id="resT" class="math-val">-</span></div>
        <div class="math-card"><span>Win Rate</span><span id="resWR" class="math-val">-</span></div>
        <div class="math-card"><span>Profitto Netto</span><span id="resP" class="math-val">-</span></div>
        <div class="math-card"><span>Edge Reale</span><span id="resE" class="math-val">-</span></div>
    </div>
    <div id="finalTable"></div>
  </div>

<script>
let dataR = [], dataQ = [];
const clean = s => String(s||"").toLowerCase().replace(/[^a-z0-9]/g, "").trim();
const fmtD = d => {
    let s = String(d).trim().replace(/\//g, '-');
    if(!s.includes('-')) return s;
    let p = s.split('-');
    return p[0].length === 4 ? s : `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
};

async function parse(f) {
    const t = await f.text();
    const rows = t.split(/\r?\n/).filter(l => l.trim() !== "");
    const h = rows[0].split(",").map(x => x.trim().toLowerCase());
    return rows.slice(1).map(r => {
        let o = {}, c = r.split(",");
        h.forEach((name, i) => o[name] = c[i]?.trim());
        return o;
    });
}

async function caricaDati() {
    dataR = await parse(document.getElementById('fRes').files[0]);
    dataQ = await parse(document.getElementById('fQuo').files[0]);
    
    // Trova tutte le leghe presenti in entrambi i file
    let lSet = new Set();
    dataQ.forEach(q => { if(q.league) lSet.add(q.league.toUpperCase()) });
    dataR.forEach(r => { if(r.league) lSet.add(r.league.toUpperCase()) });
    
    let leagues = Array.from(lSet).sort();
    let html = "<table><tr><th>Lega</th><th>Soglia Minima %</th><th>Stake (u)</th></tr>";
    leagues.forEach(l => {
        html += `<tr>
            <td><b>${l}</b></td>
            <td><input type="number" class="cfg-input" id="thr_${l}" value="50"> %</td>
            <td><input type="number" class="cfg-input" id="stk_${l}" value="1.0" step="0.1"></td>
        </tr>`;
    });
    document.getElementById('leagueGrid').innerHTML = html + "</table>";
    document.getElementById('setupLega').style.display = "block";
}

function eseguiBacktest() {
    const resMap = new Map();
    dataR.forEach(r => resMap.set(`${clean(r.home_team)}|${fmtD(r.date)}`, r));

    let stats = { t:0, w:0, p:0, e:0 };
    let legheStats = {};

    dataQ.forEach(q => {
        const key = `${clean(q.home_team)}|${fmtD(q.date)}`;
        const match = resMap.get(key);
        const lKey = (q.league || match?.league || "UNK").toUpperCase();
        
        if(match) {
            const soglia = (parseFloat(document.getElementById(`thr_${lKey}`)?.value) || 50) / 100;
            const stake = parseFloat(document.getElementById(`stk_${lKey}`)?.value) || 1.0;
            
            let prob = 0.62; // Qui andrebbe la tua formula di densità
            
            if(prob >= soglia) {
                let hg = parseInt(match.fthg), ag = parseInt(match.ftag);
                if(!isNaN(hg)) {
                    let win = (hg + ag) >= 3;
                    let quota = parseFloat(q.b365_2) || 1.85;
                    let prof = win ? (stake * (quota - 1)) : -stake;

                    if(!legheStats[lKey]) legheStats[lKey] = { t:0, w:0, p:0 };
                    legheStats[lKey].t++;
                    if(win) legheStats[lKey].w++;
                    legheStats[lKey].p += prof;

                    stats.t++; stats.e += prob;
                    if(win) stats.w++;
                    stats.p += prof;
                }
            }
        }
    });

    // Update UI
    document.getElementById('dashboard').style.display = "block";
    document.getElementById('resT').innerText = stats.t;
    document.getElementById('resWR').innerText = ((stats.w/stats.t)*100).toFixed(1) + "%";
    document.getElementById('resP').innerText = stats.p.toFixed(2) + " u.";
    document.getElementById('resE').innerText = (stats.w - stats.e).toFixed(2);

    let h = "<table><tr><th>Lega</th><th>Scommesse</th><th>Win Rate</th><th>Profitto (u)</th></tr>";
    for(let l in legheStats) {
        let d = legheStats[l];
        h += `<tr>
            <td><b>${l}</b></td>
            <td><span class="badge-count">${d.t} bet</span></td>
            <td>${((d.w/d.t)*100).toFixed(1)}%</td>
            <td class="${d.p>=0?'pos':'neg'}">${d.p.toFixed(2)}</td>
        </tr>`;
    }
    document.getElementById('finalTable').innerHTML = h + "</table>";
}
</script>
</body>
</html>
