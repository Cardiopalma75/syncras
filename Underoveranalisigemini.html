
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Syncras Pro - Advanced Analytics Dashboard</title>
  <style>
    :root{--violet:#6C5CE7;--bg:#f0f2f5;--card:#fff;--border:#d1d5db;--text:#1f2937;--success:#10b981;--danger:#ef4444;--bet:#facc15}
    body{font-family:system-ui,sans-serif;margin:20px;background:var(--bg);color:var(--text);font-size:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
    button{cursor:pointer;background:var(--violet);color:#fff;border:0;font-weight:700;padding:12px 20px;border-radius:8px;width:100%}
    input, select{width:100%;padding:8px;margin-top:5px;border:1px solid var(--border);border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
    th{background:#f9fafb;font-size:11px;color:#6b7280;text-transform:uppercase}
    .stat-val{font-size:22px;font-weight:800;display:block;margin-top:5px}
    .bet-now{background:black; color:var(--bet); padding:3px 6px; border-radius:4px; font-weight:bold; font-size:11px}
    .badge{padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold;background:#e5e7eb}
  </style>
</head>
<body>

<h2>Syncras Pro v4.0 <span style="font-size:12px; font-weight:normal; color:gray;">(Last 10 Analytics)</span></h2>

<div class="card">
  <h3>‚öôÔ∏è Impostazioni Algoritmo</h3>
  <div class="grid-3">
    <div>
      <label>Soglia Confidenza (%)</label>
      <input type="number" id="threshold" value="63" min="50" max="90">
      <small>Pi√π √® alta, meno scommesse fai (ma pi√π sicure)</small>
    </div>
    <div>
      <label>Quota Media (ROI)</label>
      <input type="number" id="avgQuota" value="1.70" step="0.05">
      <small>Usata per calcolare le vincite totali</small>
    </div>
    <div style="display:flex;align-items:flex-end">
      <button onclick="elabora()">AGGIORNA ANALISI</button>
    </div>
  </div>
</div>

<div class="grid-3" id="mainStats">
  <div class="card"><span style="color:gray">Match Analizzati</span><span id="totMatch" class="stat-val">0</span></div>
  <div class="card"><span style="color:gray">Scommesse Fatte</span><span id="totBets" class="stat-val">0</span></div>
  <div class="card"><span style="color:gray">Vincita Totale</span><span id="totProfit" class="stat-val" style="color:var(--success)">0.00 u.</span></div>
</div>

<div class="card" id="leagueSection" style="display:none">
  <h3>üìä Media Over per Lega (Baseline)</h3>
  <div id="leagueTable"></div>
</div>

<div class="card">
  <h3>üìã Segnali e Backtest</h3>
  <div style="margin-bottom:10px">
    <input id="fRes" type="file" style="width:45%; display:inline-block">
    <input id="fQuo" type="file" style="width:45%; display:inline-block">
  </div>
  <div id="output"></div>
</div>

<script>
let teamLeagueMap = {};

function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    return lines.slice(1).map(line => {
        const cols = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h] = cols[i]);
        return obj;
    });
}

function getLeagueInfo(results) {
    const stats = {};
    results.forEach(r => {
        const lg = r.league || "Unknown";
        if (!stats[lg]) stats[lg] = { t: 0, o: 0 };
        const total = parseFloat(r.fthg) + parseFloat(r.ftag);
        if (!isNaN(total)) {
            stats[lg].t++;
            if (total > 2.5) stats[lg].o++;
            teamLeagueMap[r.home_team] = lg;
        }
    });
    return stats;
}

function getRecentStats(team, allResults, currentDate) {
    const history = allResults
        .filter(r => (r.home_team === team || r.away_team === team) && new Date(r.date) < new Date(currentDate))
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);
    if (history.length < 5) return null;
    let gf = 0, ga = 0;
    history.forEach(r => {
        const isHome = r.home_team === team;
        gf += isHome ? parseFloat(r.fthg) : parseFloat(r.ftag);
        ga += isHome ? parseFloat(r.ftag) : parseFloat(r.fthg);
    });
    return { avgF: gf / history.length, avgS: ga / history.length };
}

async function elabora() {
    const resFile = document.getElementById('fRes').files[0];
    const quoFile = document.getElementById('fQuo').files[0];
    if(!resFile || !quoFile) return alert("Carica i file CSV");

    const resData = parseCSV(await resFile.text());
    const quoData = parseCSV(await quoFile.text());
    const leagueBaselines = getLeagueInfo(resData);
    const userThreshold = document.getElementById('threshold').value / 100;
    const userQuota = parseFloat(document.getElementById('avgQuota').value);

    // Mostra Medie Leghe
    let lHtml = "<table><tr><th>Lega</th><th>Match Totali</th><th>Media Over %</th></tr>";
    Object.keys(leagueBaselines).forEach(l => {
        const p = (leagueBaselines[l].o / leagueBaselines[l].t * 100).toFixed(1);
        lHtml += `<tr><td><span class="badge">${l}</span></td><td>${leagueBaselines[l].t}</td><td><b>${p}%</b></td></tr>`;
    });
    document.getElementById('leagueTable').innerHTML = lHtml + "</table>";
    document.getElementById('leagueSection').style.display = "block";

    let counts = { tot: 0, bets: 0, hits: 0, profit: 0 };
    let html = `<table><thead><tr><th>Match</th><th>Lega</th><th>P(Over)</th><th>Esito / Segnale</th></tr></thead><tbody>`;

    quoData.forEach(q => {
        counts.tot++;
        const hStats = getRecentStats(q.home_team, resData, q.date);
        const aStats = getRecentStats(q.away_team, resData, q.date);
        if(!hStats || !aStats) return;

        const mu = (hStats.avgF + aStats.avgS + aStats.avgF + hStats.avgS) / 2;
        let prob = 0.50 + (mu - 2.5) * 0.18;
        if(parseFloat(q.b365_x) > 3.70) prob += 0.05;

        const matchReale = resData.find(r => r.home_team === q.home_team && r.date === q.date);
        let esito = "";

        if(prob >= userThreshold) {
            counts.bets++;
            if(matchReale) {
                const win = (parseFloat(matchReale.fthg) + parseFloat(matchReale.ftag)) > 2.5;
                if(win) { counts.hits++; counts.profit += (userQuota - 1); esito = "<b style='color:var(--success)'>VINTO</b>"; }
                else { counts.profit -= 1; esito = "<b style='color:var(--danger)'>PERSO</b>"; }
            } else {
                esito = "<span class='bet-now'>üöÄ BET OVER</span>";
            }
        }

        if(esito !== "") {
            html += `<tr>
                <td>${q.home_team}-${q.away_team}<br><small>${q.date}</small></td>
                <td><span class="badge">${teamLeagueMap[q.home_team] || 'N/A'}</span></td>
                <td><b>${(prob*100).toFixed(0)}%</b></td>
                <td>${esito}</td>
            </tr>`;
        }
    });

    document.getElementById('totMatch').innerText = counts.tot;
    document.getElementById('totBets').innerText = counts.bets;
    document.getElementById('totProfit').innerText = counts.profit.toFixed(2) + " u.";
    document.getElementById('output').innerHTML = html + "</tbody></table>";
}
</script>
</body>
</html>
