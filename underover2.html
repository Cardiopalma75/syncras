<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Syncras – Statistiche Under/Over 2.5 (Offline • 2 CSV)</title>
  <style>
    :root{--violet:#6C5CE7;--bg:#f7f7fb;--card:#fff;--border:#e7e7f5;--text:#111827;--muted:#6b7280}
    body{font-family:system-ui,Arial;margin:18px;background:var(--bg);color:var(--text)}
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:14px}
    input,select,button{padding:9px;border-radius:12px;border:1px solid #cfcfe6}
    input[type="file"]{padding:10px}
    button{cursor:pointer;background:var(--violet);color:#fff;border:0;font-weight:900;padding:12px 14px;border-radius:14px}
    button:hover{filter:brightness(.96)}
    small{color:#555;line-height:1.35}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);background:#fafafe;border-radius:999px;padding:6px 10px;font-size:12px;color:#555}
    table{border-collapse:collapse;width:100%;margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:right;font-size:13px;vertical-align:top}
    th{background:#fafafe;color:#333;font-size:12px}
    th:first-child,td:first-child{text-align:left}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    hr{border:none;border-top:1px solid #e9e9f7}
    .warn{color:#d97706}
  </style>
</head>

<body>
  <h2>Syncras – Statistiche Under/Over 2.5 (Offline • 2 CSV)</h2>
  <div class="muted">
    Carica: (1) Risultati giocati (con FTHG/FTAG) • (2) Quote pre-match (1/X/2; opzionale U/O).<br>
    Output: solo <b>statistiche e percentuali</b> Under/Over 2.5 (nessun grafico, nessuna selezione).
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label><b>CSV RISULTATI (giocato)</b></label><br>
        <input id="csvResultsFile" type="file" accept=".csv,text/csv" style="width:100%">
        <small class="muted">Serve: <span class="mono">date, home_team, away_team, FTHG, FTAG</span> (e/o FTR)</small>
      </div>

      <div>
        <label><b>CSV QUOTE (pre-match)</b></label><br>
        <input id="csvQuotesFile" type="file" accept=".csv,text/csv" style="width:100%">
        <small class="muted">
          Serve: <span class="mono">date, home_team, away_team, b365_h, b365_x, b365_a</span><br>
          Opzionali se presenti: <span class="mono">b365_u25, b365_o25</span>
        </small>
      </div>

      <div>
        <label><b>Impostazioni output</b></label><br>
        <div class="row">
          <label>Bin quote</label>
          <input id="bin" type="number" value="0.25" step="0.05" style="width:110px">
          <label>Min N per bin</label>
          <input id="minN" type="number" value="20" step="1" style="width:110px">
        </div>
        <div class="row" style="margin-top:8px">
          <label>Team norm</label>
          <select id="teamNorm">
            <option value="trimLower" selected>trim+lower</option>
            <option value="none">none</option>
          </select>
          <label>Date parse</label>
          <span class="pill">YYYY-MM-DD • DD/MM/YYYY • DD/MM/YY</span>
        </div>
      </div>
    </div>

    <hr style="margin:14px 0">

    <div class="row">
      <button id="runBtn" type="button">Calcola statistiche Under/Over 2.5</button>
      <span id="status" class="muted"></span>
    </div>

    <small style="display:block;margin-top:10px">
      Studio informativo. Nessun invito a scommettere.
    </small>
  </div>

  <div id="output"></div>

<script>
/* =========================
   Under/Over 2.5 – Stats only
   - Merge risultati↔quote su (data + home + away)
   - Calcolo U/O da FTHG+FTAG
   - Tabelle percentuali per:
     * quota X
     * favorita (min(1,2))
     * spread |1-2|
     * (se presenti) quota Under/Over (b365_u25/b365_o25)
========================= */

/* ---------- CSV parser robusto ---------- */
function parseCSV(text){
  const rows=[];
  let row=[], cur="", inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], nx=text[i+1];
    if(ch === '"'){
      if(inQ && nx === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if(!inQ && (ch===',' || ch===';')){ row.push(cur); cur=""; continue; }
    if(!inQ && ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=""; continue; }
    if(!inQ && ch==='\r') continue;
    cur+=ch;
  }
  row.push(cur); rows.push(row);
  if(rows.length && rows[rows.length-1].every(c=>String(c).trim()==="")) rows.pop();
  const header = (rows[0]||[]).map(x=>String(x).trim());
  return rows.slice(1).map(r=>{
    const o={};
    for(let i=0;i<header.length;i++){
      o[header[i]] = String(r[i]??"").trim().replace(/"/g,"");
    }
    return o;
  });
}
function normKey(s){ return String(s||"").trim().toLowerCase(); }
function pick(o, keys){
  const map={};
  for(const k in o) map[normKey(k)] = o[k];
  for(const k of keys){
    const v = map[normKey(k)];
    if(v!==undefined) return v;
  }
  return undefined;
}
function toNum(x){
  const s=String(x??"").trim().replace(",",".");
  const n=Number(s);
  return Number.isFinite(n) ? n : NaN;
}

/* ---------- date parse ---------- */
function parseDateTs(s){
  const t = String(s ?? "").trim();
  if(!t) return NaN;

  if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return Date.parse(t + "T00:00:00Z");

  let m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){
    const dd=+m[1], mm=+m[2], yyyy=+m[3];
    const iso = `${yyyy.toString().padStart(4,'0')}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    return Date.parse(iso+"T00:00:00Z");
  }

  m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})$/);
  if(m){
    const dd=+m[1], mm=+m[2], yy=+m[3];
    const yyyy = (yy>=70) ? (1900+yy) : (2000+yy);
    const iso = `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    return Date.parse(iso+"T00:00:00Z");
  }

  const x = Date.parse(t);
  return Number.isFinite(x) ? x : NaN;
}

/* ---------- team norm ---------- */
function normTeam(s, mode){
  const t = String(s||"");
  if(mode==="none") return t;
  return t.trim().toLowerCase();
}

/* ---------- merge key ---------- */
function keyOf(dateTs, home, away){ return `${dateTs}|${home}|${away}`; }

/* ---------- FileReader ---------- */
async function readFileText(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(String(r.result||""));
    r.onerror=rej;
    r.readAsText(file);
  });
}

/* ---------- normalize rows ---------- */
function normResultRow(o, teamMode){
  const dateStr = String(pick(o,["date","match_date","data","giorno","Date","DATA"])||"").trim();
  const home_team = normTeam(pick(o,["home_team","hometeam","home","HomeTeam","CASA"])||"", teamMode);
  const away_team = normTeam(pick(o,["away_team","awayteam","away","AwayTeam","TRASFERTA"])||"", teamMode);

  const FTHG = pick(o,["FTHG","fthg","hg","home_goals","HomeGoals"]) ?? "";
  const FTAG = pick(o,["FTAG","ftag","ag","away_goals","AwayGoals"]) ?? "";

  const dateTs = parseDateTs(dateStr);

  const hg = toNum(FTHG);
  const ag = toNum(FTAG);
  const goalsOk = Number.isFinite(hg) && Number.isFinite(ag);
  const total = goalsOk ? (hg+ag) : NaN;

  const uo = goalsOk ? (total <= 2 ? "U" : "O") : ""; // Under/Over 2.5

  return {dateStr, dateTs, home_team, away_team, hg, ag, total, goalsOk, uo};
}

function normQuoteRow(o, teamMode){
  const dateStr = String(pick(o,["date","match_date","data","giorno","Date","DATA"])||"").trim();
  const home_team = normTeam(pick(o,["home_team","hometeam","home","HomeTeam","CASA"])||"", teamMode);
  const away_team = normTeam(pick(o,["away_team","awayteam","away","AwayTeam","TRASFERTA"])||"", teamMode);

  const b365_h = pick(o,["b365_h","b365_1","B365H","odd1","odds_1","1","home"]) ?? "";
  const b365_x = pick(o,["b365_x","B365D","oddx","odds_x","X","draw"]) ?? "";
  const b365_a = pick(o,["b365_a","b365_2","B365A","odd2","odds_2","2","away"]) ?? "";

  // opzionali U/O (se esistono nel CSV quote)
  const b365_u25 = pick(o,["b365_u25","b365_u_25","b365_under25","under25","u25","under_2_5","under2.5","B365U"]) ?? "";
  const b365_o25 = pick(o,["b365_o25","b365_o_25","b365_over25","over25","o25","over_2_5","over2.5","B365O"]) ?? "";

  const dateTs = parseDateTs(dateStr);
  return {dateStr, dateTs, home_team, away_team,
          b365_h:String(b365_h).trim(), b365_x:String(b365_x).trim(), b365_a:String(b365_a).trim(),
          b365_u25:String(b365_u25).trim(), b365_o25:String(b365_o25).trim()};
}

/* ---------- binning + stats aggregation ---------- */
function binLabel(x, bin){
  if(!Number.isFinite(x)) return "—";
  const b = Math.max(0.05, bin);
  const lo = Math.floor(x / b) * b;
  const hi = lo + b;
  const f = (v)=> (Math.round(v*100)/100).toFixed(2);
  return `${f(lo)}–${f(hi)}`;
}
function pct(a,b){ return b ? (100*a/b) : 0; }

function initAgg(){
  return {n:0, U:0, O:0};
}
function addAgg(map, key, uo){
  if(!map.has(key)) map.set(key, initAgg());
  const v = map.get(key);
  v.n++;
  if(uo==="U") v.U++;
  if(uo==="O") v.O++;
}

/* ---------- rendering ---------- */
function renderTable(title, map, minN){
  const rows = Array.from(map.entries())
    .map(([k,v])=>{
      // sort key by numeric low
      const m = String(k).match(/^(\d+(\.\d+)?)/);
      const lo = m ? Number(m[1]) : 1e9;
      return {k, lo, v};
    })
    .sort((a,b)=>a.lo-b.lo)
    .filter(x=>x.v.n >= minN)
    .map(x=>`
      <tr>
        <td class="mono">${x.k}</td>
        <td class="mono">${x.v.n}</td>
        <td><b>${pct(x.v.U,x.v.n).toFixed(1)}%</b> <span class="muted">(U=${x.v.U})</span></td>
        <td><b>${pct(x.v.O,x.v.n).toFixed(1)}%</b> <span class="muted">(O=${x.v.O})</span></td>
      </tr>
    `).join("");

  const empty = `<tr><td colspan="4" class="muted">Nessun bin con N ≥ ${minN}. Abbassa “Min N per bin”.</td></tr>`;

  return `
    <div class="card">
      <b>${title}</b>
      <table>
        <thead>
          <tr>
            <th>Range quota</th>
            <th>N</th>
            <th>Under 2.5</th>
            <th>Over 2.5</th>
          </tr>
        </thead>
        <tbody>${rows || empty}</tbody>
      </table>
    </div>
  `;
}

/* ---------- MAIN ---------- */
async function run(){
  const status = document.getElementById("status");
  const output = document.getElementById("output");
  status.textContent = "Carico CSV…";
  output.innerHTML = "";

  try{
    const fRes = document.getElementById("csvResultsFile").files?.[0];
    const fQuo = document.getElementById("csvQuotesFile").files?.[0];
    if(!fRes || !fQuo){
      status.textContent = "⚠️ Seleziona entrambi i CSV.";
      return;
    }

    const teamMode = document.getElementById("teamNorm").value;
    const bin = +document.getElementById("bin").value || 0.25;
    const minN = Math.max(5, +document.getElementById("minN").value || 20);

    const resText = await readFileText(fRes);
    const quoText = await readFileText(fQuo);

    const results = parseCSV(resText).map(o=>normResultRow(o, teamMode))
      .filter(r=>r.dateStr && r.home_team && r.away_team && Number.isFinite(r.dateTs) && r.goalsOk && (r.uo==="U"||r.uo==="O"));

    const quotes = parseCSV(quoText).map(o=>normQuoteRow(o, teamMode))
      .filter(q=>q.dateStr && q.home_team && q.away_team && Number.isFinite(q.dateTs));

    // map risultati
    const resMap = new Map();
    for(const r of results){
      resMap.set(keyOf(r.dateTs, r.home_team, r.away_team), r);
    }

    // merge
    let merged=0, notMatched=0;
    let U=0,O=0;

    const byX = new Map();
    const byFav = new Map();
    const bySpread = new Map();
    const byU25 = new Map(); // only if present
    const byO25 = new Map(); // only if present
    let hasUOodds = false;

    for(const q of quotes){
      const r = resMap.get(keyOf(q.dateTs, q.home_team, q.away_team));
      if(!r){ notMatched++; continue; }

      merged++;
      if(r.uo==="U") U++;
      if(r.uo==="O") O++;

      const odd1 = toNum(q.b365_h);
      const oddX = toNum(q.b365_x);
      const odd2 = toNum(q.b365_a);

      const fav = Math.min(odd1, odd2);
      const spread = Math.abs(odd1-odd2);

      addAgg(byX, binLabel(oddX, bin), r.uo);
      addAgg(byFav, binLabel(fav, bin), r.uo);
      addAgg(bySpread, binLabel(spread, bin), r.uo);

      const oddU = toNum(q.b365_u25);
      const oddO = toNum(q.b365_o25);
      if(Number.isFinite(oddU) || Number.isFinite(oddO)) hasUOodds = true;
      if(Number.isFinite(oddU)) addAgg(byU25, binLabel(oddU, bin), r.uo);
      if(Number.isFinite(oddO)) addAgg(byO25, binLabel(oddO, bin), r.uo);
    }

    const pU = merged ? (100*U/merged) : 0;
    const pO = merged ? (100*O/merged) : 0;

    output.innerHTML = `
      <div class="card">
        <b>Riepilogo</b>
        <div class="row" style="margin-top:10px">
          <span class="pill"><b>Match matchati:</b> ${merged}</span>
          <span class="pill"><b>Non matchati:</b> ${notMatched}</span>
          <span class="pill"><b>Under 2.5:</b> ${U} (${pU.toFixed(1)}%)</span>
          <span class="pill"><b>Over 2.5:</b> ${O} (${pO.toFixed(1)}%)</span>
          <span class="pill">Bin: <span class="mono">${bin.toFixed(2)}</span></span>
          <span class="pill">Min N/bin: <span class="mono">${minN}</span></span>
        </div>
        <small style="display:block;margin-top:10px" class="muted">
          Se nel CSV quote non hai b365_u25/b365_o25 è normale: le tabelle U/O per quota Under/Over non compariranno.
        </small>
      </div>

      ${renderTable("Under/Over 2.5 per QUOTA X (b365_x)", byX, minN)}
      ${renderTable("Under/Over 2.5 per FAVORITA (min(1,2))", byFav, minN)}
      ${renderTable("Under/Over 2.5 per SPREAD |1-2|", bySpread, minN)}

      ${hasUOodds ? renderTable("Under/Over 2.5 per QUOTA UNDER 2.5 (b365_u25) – se presente nel CSV", byU25, minN) : ""}
      ${hasUOodds ? renderTable("Under/Over 2.5 per QUOTA OVER 2.5 (b365_o25) – se presente nel CSV", byO25, minN) : ""}
    `;

    status.textContent = "Completato ✅";
  }catch(e){
    status.textContent = "Errore: " + (e?.message || e);
  }
}

document.getElementById("runBtn").addEventListener("click", run);
</script>

</body>
</html>
