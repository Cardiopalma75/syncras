<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Syncras – SEGNALA SOLO X (Context Aware)</title>

<style>
:root{--violet:#6C5CE7;--bg:#f7f7fb;--card:#fff;--border:#e7e7f5;--text:#111827;--muted:#6b7280}
body{font-family:system-ui,Arial;margin:18px;background:var(--bg);color:var(--text)}
h2{margin:0 0 10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:14px}
input,select,button{padding:9px;border-radius:12px;border:1px solid #cfcfe6}
input[type=file]{padding:10px}
button{cursor:pointer;background:var(--violet);color:#fff;border:0;font-weight:900;padding:12px 14px;border-radius:14px}
button:hover{filter:brightness(.96)}
small{color:#555}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
@media(max-width:820px){.grid{grid-template-columns:1fr}}
table{border-collapse:collapse;width:100%;margin-top:12px;background:#fff;border:1px solid var(--border)}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:right;font-size:13px}
th{background:#fafafe}
th:first-child,td:first-child{text-align:left}
.mono{font-family:ui-monospace,monospace}
.ok{color:#0a7}.warn{color:#d97706}.bad{color:#c22}
</style>
</head>

<body>

<h2>Syncras – “SEGNALA” SOLO X</h2>
<div class="muted">Tool offline • 2 CSV • Lettura del mercato • Nessun invito a scommettere</div>

<div class="card">
<div class="grid">
<div>
<b>CSV Risultati (storico)</b><br>
<input type="file" id="csvResults" accept=".csv">
</div>
<div>
<b>CSV Quote (future)</b><br>
<input type="file" id="csvQuotes" accept=".csv">
</div>
<div>
<b>Output</b><br>
<small>1–2 partite da attenzionare (SOLO X)</small>
</div>
</div>

<hr>

<div class="row">
<label>N</label><input id="N" type="number" value="10" style="width:70px">
<label>EV min %</label><input id="evMin" type="number" value="15" style="width:80px">
<label>X min</label><input id="qMin" type="number" value="3.0" step="0.1" style="width:80px">
<label>X max</label><input id="qMax" type="number" value="4.8" step="0.1" style="width:80px">
<label>Output</label><input id="topK" type="number" value="2" style="width:60px">
<label>Bootstrap B</label><input id="B" type="number" value="800" style="width:80px">
</div>

<div class="row" style="margin-top:10px">
<button onclick="run()">Analizza</button>
<span id="status"></span>
</div>
</div>

<div id="output"></div>

<script>
/* ================= UTIL ================= */
function parseCSV(t){
 const l=t.trim().split(/\r?\n/);
 const h=l[0].split(",");
 return l.slice(1).map(r=>{
  const c=r.split(",");
  let o={};h.forEach((k,i)=>o[k.trim()]=c[i]?.trim());
  return o;
 });
}
const num=x=>Number(String(x||"").replace(",","."))||NaN;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

/* ====== DECAY AGGRESSIVO ====== */
function weights(n){
 return Array.from({length:n},(_,i)=>Math.pow(1.5,i));
}

/* ====== P(X) STATISTICO ====== */
function calcPX(rows,match,N){
 const prev=rows.filter(r=>r.date<match.date);
 const rate=t=>{
  const m=prev.filter(r=>r.home==t||r.away==t).slice(-N);
  const w=weights(m.length);
  let s=0,d=0;
  m.forEach((r,i)=>{if(r.result=="X")s+=w[i];d+=w[i];});
  return d?s/d:0;
 };
 const p=(rate(match.home)+rate(match.away))/2;
 return clamp(p,0.10,0.55);
}

/* ====== MARKET CORRELATION ====== */
function marketFactor(o1,o2){
 let f=1;
 if(o1>=2.40 && o2>=2.40) f+=0.08;
 if(o1<=1.60 || o2<=1.60) f-=0.10;
 if(o2<2.50) f+=0.06; // X da trasferta
 return clamp(f,0.75,1.15);
}

/* ====== GOALS AGAINST ====== */
function goalsAgainst(rows,team,N,date){
 const m=rows.filter(r=>r.date<date&&(r.home==team||r.away==team)).slice(-N);
 return m.map(r=>r.home==team?num(r.FTAG):num(r.FTHG)).filter(Number.isFinite);
}

/* ====== BOOTSTRAP DECISIONALE ====== */
function bootstrap(rows,match,N,B){
 const vals=[];
 for(let i=0;i<B;i++){
  const s=[...rows].sort(()=>.5-Math.random());
  vals.push(calcPX(s,match,N));
 }
 vals.sort((a,b)=>a-b);
 return vals[Math.floor(B*0.05)];
}

/* ================= MAIN ================= */
async function run(){
 const out=document.getElementById("output");
 const st=document.getElementById("status");
 st.textContent="Calcolo…";
 out.innerHTML="";

 const R=parseCSV(await csvResults.files[0].text()).map(r=>({
  date:r.date,home:r.home_team,away:r.away_team,
  result:r.result,FTHG:r.FTHG,FTAG:r.FTAG
 }));
 const Q=parseCSV(await csvQuotes.files[0].text()).map(q=>({
  date:q.date,home:q.home_team,away:q.away_team,
  x:num(q.b365_x),o1:num(q.b365_1),o2:num(q.b365_2)
 }));

 const N=+document.getElementById("N").value||10;
 const evMin=(+document.getElementById("evMin").value||15)/100;
 const qMin=+document.getElementById("qMin").value||3;
 const qMax=+document.getElementById("qMax").value||4.8;
 const topK=+document.getElementById("topK").value||2;
 const B=+document.getElementById("B").value||800;

 let res=[];
 for(const q of Q){
  if(q.x<qMin||q.x>qMax)continue;
  const m={date:q.date,home:q.home,away:q.away};

  let pX=calcPX(R,m,N);
  let pAdj=clamp(pX*marketFactor(q.o1,q.o2),0.10,0.65);
  let EV=pAdj*q.x-1;
  if(EV<evMin)continue;

  const gaH=goalsAgainst(R,m.home,N,m.date);
  const gaA=goalsAgainst(R,m.away,N,m.date);
  if(gaH.length>=3&&gaA.length>=3){
   if((gaH.reduce((a,b)=>a+b)/gaH.length)<1.2 &&
      (gaA.reduce((a,b)=>a+b)/gaA.length)<1.2){
     pAdj=clamp(pAdj*1.08,0.10,0.65);
     EV=pAdj*q.x-1;
   }
  }

  const p05=bootstrap(R,m,N,B);
  if(p05 <= 1/q.x)continue;

  res.push({m,pAdj,EV,p05});
 }

 res.sort((a,b)=>b.EV-a.EV);
 res=res.slice(0,topK);

 if(!res.length){
  out.innerHTML='<div class="card"><b>Nessuna partita da attenzionare</b></div>';
  st.textContent="Completato";
  return;
 }

 out.innerHTML=`
 <div class="card">
 <table>
 <tr><th>Match</th><th>P(X)</th><th>EV</th><th>Bootstrap p05</th></tr>
 ${res.map(r=>`
 <tr>
 <td><b>${r.m.home} – ${r.m.away}</b></td>
 <td>${(r.pAdj*100).toFixed(1)}%</td>
 <td class="${r.EV>0.3?'ok':'warn'}">${(r.EV*100).toFixed(1)}%</td>
 <td>${(r.p05*100).toFixed(1)}%</td>
 </tr>`).join("")}
 </table>
 </div>`;
 st.textContent="Completato";
}
</script>

</body>
</html>
