-------- */
function calcPX(results, match, N, decayMode, useHomeAway){
  const prev = results.filter(x => isPlayed(x) && Number.isFinite(x.dateTs) && Number.isFinite(match.dateTs) && x.dateTs < match.dateTs);

  let homeHist, awayHist;
  if(useHomeAway){
    homeHist = prev.filter(x=>x.home_team===match.home_team);
    awayHist = prev.filter(x=>x.away_team===match.away_team);
  }else{
    homeHist = prev.filter(x=>x.home_team===match.home_team || x.away_team===match.home_team);
    awayHist = prev.filter(x=>x.home_team===match.away_team || x.away_team===match.away_team);
  }

  const hX = homeHist.filter(x=>x.result==="X").length / (homeHist.length||1);
  const aX = awayHist.filter(x=>x.result==="X").length / (awayHist.length||1);
  const histPX = (hX + aX) / 2;

  const sortedPrev = prev.slice().sort((a,b)=>b.dateTs - a.dateTs);

  const homeRecent = sortedPrev
    .filter(x=>x.home_team===match.home_team || x.away_team===match.home_team)
    .slice(0,N).reverse();
  const awayRecent = sortedPrev
    .filter(x=>x.home_team===match.away_team || x.away_team===match.away_team)
    .slice(0,N).reverse();

  const recPX = (weightedRateDraw(match.home_team, homeRecent, decayMode) +
                 weightedRateDraw(match.away_team, awayRecent, decayMode))/2;

  const p = 0.6*recPX + 0.4*histPX;
  return Math.max(0.10, Math.min(0.55, p));
}

/* ---------- Market correlation (MOD #3) ---------- */
function marketFactor(odd1, odd2){
  let f = 1.0;

  // bonus: mercato equilibrato
  if(Number.isFinite(odd1) && Number.isFinite(odd2) && odd1>=2.40 && odd2>=2.40) f += 0.08;

  // bonus forte (raro)
  if(Number.isFinite(odd1) && Number.isFinite(odd2) && odd1>=2.80 && odd2>=2.80) f += 0.12;

  // malus: favorito forte
  if((Number.isFinite(odd1) && odd1<=1.60) || (Number.isFinite(odd2) && odd2<=1.60)) f -= 0.10;

  // malus forte
  if((Number.isFinite(odd1) && odd1<=1.45) || (Number.isFinite(odd2) && odd2<=1.45)) f -= 0.18;

  // MOD #3b: “X da trasferta” (favorita fuori casa)
  if(Number.isFinite(odd2) && odd2 < 2.50) f += 0.06;

  return Math.max(0.75, Math.min(1.15, f));
}

/* ---------- goals filter (totali) ---------- */
function teamRecentGoals(results, team, N, dateTs){
  const prev = results
    .filter(x => isPlayed(x) && Number.isFinite(x.dateTs) && x.dateTs < dateTs &&
                 (x.home_team===team || x.away_team===team))
    .sort((a,b)=>a.dateTs - b.dateTs)
    .slice(-N);

  return prev.map(x => toNum(x.FTHG)+toNum(x.FTAG)).filter(v=>Number.isFinite(v));
}

/* ---------- defense filter (GA) (MOD #4) ---------- */
function teamRecentConceded(results, team, N, dateTs){
  const prev = results
    .filter(x => isPlayed(x) && Number.isFinite(x.dateTs) && x.dateTs < dateTs &&
                 (x.home_team===team || x.away_team===team))
    .sort((a,b)=>a.dateTs - b.dateTs)
    .slice(-N);

  const out=[];
