<script>
(function(){
  const GA_ID = 'G-CFTTCYDZ2P';
  const CONSENT_KEY = 'syncras_cookie_consent';

  // GA bloccato di default
  window['ga-disable-' + GA_ID] = true;

  function loadGoogleAnalytics(){
    if (window.__syncrasGaLoaded) return;
    window.__syncrasGaLoaded = true;

    window['ga-disable-' + GA_ID] = false;

    const gaScript = document.createElement('script');
    gaScript.async = true;
    gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
    document.head.appendChild(gaScript);

    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    window.gtag = gtag;

    gtag('js', new Date());
    gtag('config', GA_ID, { anonymize_ip: true });
  }

  function showBanner(){
    const b = document.getElementById('cookie-banner');
    if (b) b.style.display = 'block';
  }
  function hideBanner(){
    const b = document.getElementById('cookie-banner');
    if (b) b.style.display = 'none';
  }

  window.acceptCookies = function(){
    localStorage.setItem(CONSENT_KEY, 'yes');
    hideBanner();
    loadGoogleAnalytics();
  };

  window.rejectCookies = function(){
    localStorage.setItem(CONSENT_KEY, 'no');
    hideBanner();
    window['ga-disable-' + GA_ID] = true;
  };

  window.revokeCookies = function(){
    localStorage.removeItem(CONSENT_KEY);
    window['ga-disable-' + GA_ID] = true;
    showBanner();
  };

  // ✅ Questa funzione deve funzionare sia “a pagina pronta” sia “dopo fetch”
  function initGdpr(){
    // collega il link "Modifica consenso cookie" nel footer
    const settings = document.getElementById('cookie-settings');
    if (settings && settings.dataset.bound !== "1") {
      settings.dataset.bound = "1";
      settings.addEventListener('click', (e) => {
        e.preventDefault();
        window.revokeCookies();
      });
    }

    // mostra banner se non c’è scelta salvata
    const consent = localStorage.getItem(CONSENT_KEY);
    if (consent === 'yes'){
      loadGoogleAnalytics();
    } else if (consent === 'no'){
      window['ga-disable-' + GA_ID] = true;
      hideBanner();
    } else {
      showBanner();
    }
  }

  // esponi init per chiamarlo dopo il fetch
  window.__syncrasInitGdpr = initGdpr;

  // se lo script viene caricato “normale”, prova anche subito
  initGdpr();

})();
</script>


