<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Calcolatore Ammortamento Fotovoltaico 2025: Calcola il Rientro Economico</title>
  <meta name="description" content="Scopri in quanto tempo si ripaga il tuo impianto fotovoltaico. Calcola produzione, risparmio annuo in bolletta, cessione energia (on-grid) e tabella di ammortamento completa.">
  <meta name="robots" content="index,follow">
  <link rel="canonical" href="https://syncras.app/calcolatore-fotovoltaico-ammortamento.html">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Calcolatore Ammortamento e Risparmio Fotovoltaico",
    "applicationCategory": "FinancialApplication",
    "operatingSystem": "All",
    "description": "Strumento per stimare produzione, autoconsumo reale, cessione energia on-grid e tempo di rientro (payback) di un impianto fotovoltaico.",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "EUR" },
    "url": "https://syncras.app/calcolatore-fotovoltaico-ammortamento.html"
  }
  </script>

  <style>
    :root{
      --violet-main:#6C5CE7;
      --violet-dark:#4B3ACB;
      --bg-page:#F7F7FB;
      --text-main:#403E43;
      --ok:#16A34A;
      --warn:#D97706;
      --bad:#DC2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      font-family:Arial,sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
      line-height:1.6;
    }

    /* HEADER */
    .site-header{
      background:linear-gradient(90deg,var(--violet-dark),var(--violet-main));
      color:#fff;
      padding:12px 14px;
      box-shadow:0 2px 4px rgba(0,0,0,.15);
      position:sticky; top:0; z-index:100;
    }
    .header-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      position:relative;
    }
    .logo{font-size:1.4rem;font-weight:bold;letter-spacing:.03em}
    #main-nav{display:flex;gap:14px;font-size:.95rem}
    #main-nav a{
      color:#fff;text-decoration:none;font-weight:600;
      padding-bottom:2px;border-bottom:2px solid transparent;opacity:.95;
    }
    #main-nav a:hover{ text-decoration:underline; opacity:1; }

    .menu-toggle{
      display:none;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.4);
      border-radius:6px;
      color:white;
      padding:6px 10px;
      font-size:.9rem;
      cursor:pointer;
    }
    .menu-toggle span{margin-left:4px;font-size:1.1rem}

    @media (max-width:768px){
      #main-nav{
        display:none;
        position:absolute;
        left:0; right:0;
        top:52px;
        margin:0 auto;
        max-width:980px;
        flex-direction:column;
        background-color:var(--violet-dark);
        padding:10px 16px 12px 16px;
        border-radius:0 0 8px 8px;
        box-shadow:0 3px 6px rgba(0,0,0,.25);
        z-index:50;
      }
      #main-nav a{padding:6px 0}
      body.nav-open #main-nav{display:flex}
      .menu-toggle{display:inline-flex;align-items:center}
    }

    /* MAIN */
    main{
      max-width:980px;
      margin:24px auto 32px;
      padding:18px 16px 24px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 8px rgba(0,0,0,.08);
    }
    h1,h2,h3{color:var(--violet-dark);margin-top:0}
    .back-links{font-size:.9rem;margin-bottom:10px}
    .back-links a{color:var(--violet-dark);text-decoration:none;font-weight:600}
    .back-links a:hover{text-decoration:underline}

    .page-intro{
      margin-bottom:16px;
      border-bottom:1px solid #e5e7eb;
      padding-bottom:12px;
    }
    .badge-page{
      display:inline-block;
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      background:rgba(108,92,231,.08);
      border:1px solid rgba(108,92,231,.35);
      border-radius:999px;
      padding:2px 8px;
      color:#3730a3;
      margin-bottom:6px;
    }
    .intro-text{font-size:.95rem;color:#4b5563;margin-top:6px}

    /* SHARE */
    .share-btn-new{
      display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(90deg,#6C5CE7,#4B3ACB);
      color:white;font-weight:600;
      padding:10px 16px;border:none;border-radius:12px;
      font-size:.95rem;cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.15);
      transition:.25s ease;
      margin-bottom:10px;
    }
    .share-btn-new:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.20)}

    .share-btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 18px;border-radius:999px;border:none;
      background:linear-gradient(90deg,var(--violet-dark),var(--violet-main));
      color:#fff;font-weight:600;font-size:.95rem;
      cursor:pointer;
      box-shadow:0 3px 8px rgba(15,23,42,.25);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      margin:10px 0 2px;
    }
    .share-btn:hover{transform:translateY(-1px);box-shadow:0 5px 14px rgba(15,23,42,.30);opacity:.96}
    .share-btn:active{transform:translateY(1px);box-shadow:0 2px 6px rgba(15,23,42,.18)}

    /* CALC */
    .calc-section{
      margin:24px 0;
      padding:18px 16px 16px;
      border-radius:12px;
      background:#f8f9ff;
      border:1px solid #e0e7ff;
    }
    .calc-header{
      display:flex;justify-content:space-between;align-items:baseline;
      gap:8px;margin-bottom:10px;flex-wrap:wrap;
    }
    .calc-header small{font-size:.8rem;color:#6b7280}

    .pv-subsection{
      margin-top:12px;
      padding:12px 12px 10px;
      border-radius:10px;
      background:#eef2ff;
      border:1px dashed #c7d2fe;
    }
    .pv-subsection h3{margin-top:0;margin-bottom:6px;font-size:1rem}

    .pv-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px 12px;
      margin-top:4px;
    }
    .calc-field label{
      font-size:.85rem;font-weight:600;
      display:flex;align-items:center;gap:6px;
      margin-bottom:2px;
    }
    .calc-field input, .calc-field select{
      width:100%;
      padding:7px 8px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:.9rem;
    }
    .calc-button{
      margin-top:14px;
      padding:9px 15px;
      border-radius:7px;
      border:none;
      background:var(--violet-main);
      color:#fff;
      font-weight:600;
      font-size:.9rem;
      cursor:pointer;
    }
    .calc-button:hover{background:var(--violet-dark)}

    .calc-result{
      margin-top:12px;
      padding:10px 12px;
      border-radius:8px;
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
      font-size:.9rem;
      display:none;
    }
    .calc-note{font-size:.8rem;color:#6b7280;margin-top:6px}

    /* LEGAL ACCEPT */
    .legal-box-avviso{
      margin-top:14px;
      padding:10px 12px;
      background:#fff;
      border-radius:8px;
      border:1px solid #e5e7eb;
      font-size:.9rem;
      color:#374151;
    }
    .legal-box-avviso a{
      color:var(--violet-main);
      text-decoration:underline;
      font-weight:600;
    }
    .legal-note-small{margin:6px 0 0;font-size:.8rem;color:#6b7280}

    /* AMORT TABLE */
    .amort-wrapper{margin-top:14px;overflow-x:auto}
    .amort-table{width:100%;border-collapse:collapse;font-size:.85rem}
    .amort-table th,.amort-table td{
      border:1px solid #d1d5db;
      padding:6px 8px;
      text-align:right;
      white-space:nowrap;
    }
    .amort-table th{background:#e0e7ff;font-weight:600;text-align:center}
    .amort-table td:first-child, .amort-table th:first-child{ text-align:center; }
    .row-break-even{background:#dcfce7;font-weight:600}
    .amort-legend{font-size:.8rem;color:#4b5563;margin-top:6px}

    .print-btn{
      margin-top:10px;
      padding:8px 14px;
      border-radius:7px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-size:.85rem;
      font-weight:600;
      margin-left:8px;
    }
    .print-btn:hover{background:#f3f4ff}

    /* Amazon box */
    .amazon-box{
      margin-top:12px;
      padding:14px 14px 12px;
      border-radius:14px;
      background:#f5f3ff;
      border:1px solid #ddd6fe;
      font-size:.85rem;
      box-shadow:0 3px 10px rgba(15,23,42,.08);
    }
    .amazon-box strong{display:block;margin-bottom:4px;color:#4c1d95}

    @media (max-width:920px){ .pv-grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:600px){
      main{margin:16px auto 24px;padding:14px 10px 20px}
      .pv-grid{grid-template-columns:1fr}
    }

    /* FOOTER */
    .syncras-footer{
      margin-top:32px;
      padding:2.5rem 1.5rem 1.5rem;
      background:#2b1840;
      color:#f3eaff;
      font-size:.9rem;
    }
    .syncras-footer a{color:#f3eaff;text-decoration:none}
    .syncras-footer a:hover{text-decoration:underline}

    .footer-inner{
      max-width:980px;
      margin:0 auto 1.5rem auto;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:2rem;
    }
    .footer-column h4{margin-top:0;margin-bottom:.7rem;font-size:1rem}
    .footer-column p{margin:0;font-size:.85rem}
    .footer-column ul{list-style:none;padding:0;margin:0}
    .footer-column li{margin-bottom:.4rem;font-size:.85rem}
    .footer-bottom{max-width:980px;margin:0 auto;text-align:center;font-size:.8rem;opacity:.9}
    .footer-bottom p{margin:4px 0}

    /* PRINT */
    @media print{
      body{background:#fff}
      .site-header,.syncras-footer,.menu-toggle,#main-nav,#shareTop,#shareBottom,#cookie-banner,.mode-row,.coherence-box,.whatif-box,.share-row,.copy-btn{display:none !important}
      main{box-shadow:none;margin:0;padding:0;max-width:100%}
      .print-btn{display:none !important}
      .calc-section{border:none;background:#fff;padding:0;margin:0 0 12px 0}
      .pv-subsection{border:1px solid #d1d5db;background:#fff}
    }

    /* Cookie banner */
    #cookie-banner{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      max-width:90%;
      width:440px;
      background:#fff;
      border:2px solid #6C5CE7;
      border-radius:10px;
      padding:16px;
      box-shadow:0 4px 8px rgba(0,0,0,.15);
      z-index:9999;
      font-family:Arial,sans-serif;
      display:none;
    }
    #cookie-banner p{
      margin:0 0 12px 0;
      font-size:.95rem;
      color:#333;
      line-height:1.4;
    }
    #cookie-banner a{color:#6C5CE7;font-weight:bold;text-decoration:none}
    #cookie-banner .btn-row{display:flex;gap:10px;margin-top:8px}
    #cookie-banner button.reject{
      flex:1;background:white;color:#111827;
      border:2px solid #6C5CE7;
      padding:10px 12px;border-radius:6px;
      cursor:pointer;font-weight:600;
    }
    #cookie-banner button.accept{
      flex:1;background:#6C5CE7;color:white;
      border:2px solid #6C5CE7;
      padding:10px 16px;border-radius:6px;
      cursor:pointer;font-weight:700;
    }
    #cookie-banner button.accept:hover{background:#4B3ACB}

    /* NEW: helpers */
    .mode-row{
      display:flex;gap:10px;flex-wrap:wrap;
      margin:10px 0 12px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(108,92,231,.35);
      background:rgba(108,92,231,.08);
      color:#3730a3;
      padding:8px 10px;border-radius:999px;
      font-size:.85rem;font-weight:700;
      cursor:pointer; user-select:none;
    }
    .pill.active{
      background:rgba(108,92,231,.18);
      border-color:rgba(108,92,231,.55);
    }
    .tip-i{
      display:inline-flex;align-items:center;justify-content:center;
      width:18px;height:18px;border-radius:999px;
      border:1px solid #c7d2fe;
      background:#fff;color:#3730a3;
      font-size:.75rem;font-weight:800;
      cursor:help;
    }
    .tiny-help{font-size:.8rem;color:#6b7280;margin-top:4px}
    .hidden{display:none !important;}

    .coherence-box{
      margin-top:12px;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,.04);
    }
    .coherence-title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:0 0 6px 0;
    }
    .badge-status{
      display:inline-flex;align-items:center;gap:8px;
      border-radius:999px;
      padding:4px 10px;
      font-size:.8rem;font-weight:800;
      color:#fff;
    }
    .badge-ok{background:var(--ok)}
    .badge-warn{background:var(--warn)}
    .badge-bad{background:var(--bad)}
    .coherence-list{margin:6px 0 0 18px;color:#374151;font-size:.9rem}

    .headline{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      background:linear-gradient(90deg, rgba(108,92,231,.12), rgba(75,58,203,.08));
      border:1px solid rgba(108,92,231,.35);
    }
    .headline strong{font-size:1.15rem}

    .whatif-box{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      background:#fff;
      border:1px solid #e5e7eb;
    }
    .whatif-box h4{margin:0 0 8px 0;color:#4b3acb}
    .whatif-box ul{margin:0 0 0 18px}

    /* NEW: ‚Äúconti in colonna‚Äù */
    .school-sum{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff;
      border:1px solid #e5e7eb;
    }
    .school-sum .title{
      font-weight:800;
      color:#1f2937;
      margin-bottom:6px;
    }
    .sum-grid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:6px 12px;
      max-width:420px;
      font-variant-numeric: tabular-nums;
    }
    .sum-grid .label{color:#374151}
    .sum-grid .val{font-weight:800}
    .sum-line{
      grid-column:1 / -1;
      height:1px;
      background:#111827;
      opacity:.25;
      margin:2px 0;
    }
    .sum-total .label, .sum-total .val{font-weight:900}
    .caption-box{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      background:#ffffff;
      border:1px dashed #c7d2fe;
      color:#374151;
      font-size:.9rem;
    }

    .share-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .copy-btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 16px;border-radius:12px;border:1px solid rgba(108,92,231,.35);
      background:#fff;
      color:#3730a3;
      font-weight:800;
      cursor:pointer;
    }
    .copy-btn:hover{background:#f7f7fb}
  </style>
</head>

<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="logo">Syncras.App</div>

      <button class="menu-toggle" type="button" onclick="toggleMenu()" aria-label="Apri o chiudi il menu di navigazione">
        Menu <span>‚ò∞</span>
      </button>

      <nav id="main-nav">
        <a href="index.html">Home</a>
        <a href="blog.html">Blog</a>
        <a href="smart-test.html">Smart Test</a>
        <a href="calcolatori.html">Calcolatori</a>
        <a href="fast-cards.html">Fast Card</a>
        <a href="offerte.html">Prodotti Consapevoli</a>
        <a href="curiosita.html">Curiosit√†</a>
        <a href="misteri.html">Misteri</a>
        <a href="chi.html">Chi siamo</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="back-links">
      ‚Üê <a href="index.html">Torna alla Home</a> |
      <a href="calcolatori.html">Vai alla pagina Calcolatori</a>
    </div>

    <div class="page-intro">
      <span class="badge-page">Area Calcoli ‚Äì Fotovoltaico</span>
      <h1>Calcolatore Fotovoltaico con Ammortamento: rientro anno per anno</h1>

      <div style="background:#FFF4D6; padding:10px 14px; border-left:4px solid #F59E0B; border-radius:6px; margin:10px 0; font-size:0.9rem;">
        üí° <strong>Avviso:</strong> Questo calcolo rappresenta una <strong>stima indicativa</strong> basata sui dati inseriti dall‚Äôutente e su ipotesi semplificate.
        Non costituisce consulenza professionale e non tiene conto di tutti i fattori fiscali, tecnici o energetici reali.
        Per decisioni reali, confronta preventivi e consulta un <strong>tecnico abilitato</strong>.
      </div>

      <p class="intro-text">
        Inserisci i dati base: <strong>potenza</strong>, <strong>zona</strong>, <strong>consumo casa</strong> e <strong>batteria</strong>.
        Il calcolatore stima: produzione annua, energia ‚Äútenuta in casa‚Äù (anche grazie all‚Äôaccumulo), cessione (on-grid) e rientro.
      </p>
    </div>

    <!-- Note legali accettazione -->
    <div class="legal-box-avviso">
      <label>
        <input type="checkbox" id="legalAccept">
        Prima di procedere, confermo che i risultati sono stime e non sostituiscono una valutazione professionale.
        Ho letto le <a href="note-legali.html" target="_blank" rel="noopener">Note Legali</a>.
      </label>
      <p class="legal-note-small">
        I risultati sono <strong>stime orientative</strong> basate sui dati inseriti e su ipotesi semplificate.
      </p>
    </div>

    <button id="shareTop" class="share-btn-new">
      <span>üì§</span> Condividi questo calcolatore
    </button>

    <section class="calc-section" id="calc-fotovoltaico">
      <div class="calc-header">
        <h2>Calcolatore fotovoltaico: produzione, risparmio e rientro</h2>
        <small>Numeri semplici, ‚Äúspiegati a scuola‚Äù (ma senza fuffa).</small>
      </div>

      <!-- Modalit√† -->
      <div class="mode-row" aria-label="Modalit√† di compilazione">
        <div class="pill active" id="modeQuick" role="button" tabindex="0">Modalit√† Rapida (4 input)</div>
        <div class="pill" id="modePrecise" role="button" tabindex="0">Modalit√† Precisa (avanzata)</div>
      </div>
      <div class="tiny-help" id="modeHelp">
        In ‚ÄúRapida‚Äù compili solo: Potenza, Zona, Consumo casa, Batteria. Il resto usa valori medi (energia 0,30 ‚Ç¨/kWh, cessione 0,10, detrazione 50% in 10 anni, ON-GRID).
      </div>

      <!-- Coerenza / semaforo -->
      <div class="coherence-box" id="coherenceBox">
        <div class="coherence-title">
          <strong>Controllo coerenza dati</strong>
          <span class="badge-status badge-warn" id="coherenceBadge">‚ö†Ô∏è In attesa‚Ä¶</span>
        </div>
        <ul class="coherence-list" id="coherenceList">
          <li>Inserisci i dati e premi ‚ÄúCalcola impianto‚Äù.</li>
        </ul>
      </div>

      <!-- BLOCCO A -->
      <div class="pv-subsection">
        <h3>Blocco A ‚Äì Impianto fotovoltaico</h3>

        <div class="pv-grid">
          <div class="calc-field">
            <label>Potenza impianto (kW)</label>
            <input type="number" id="pvKw" min="0" max="20" step="0.1" value="10">
          </div>

          <div class="calc-field">
            <label>Zona geografica</label>
            <select id="pvZona">
              <option value="1100">Nord Italia (‚âà1100 kWh/kW anno)</option>
              <option value="1300" selected>Centro Italia (‚âà1300 kWh/kW anno)</option>
              <option value="1500">Sud / Isole (‚âà1500 kWh/kW anno)</option>
            </select>
          </div>

          <div class="calc-field">
            <label>Consumo annuo casa (kWh)</label>
            <input type="number" id="pvConsumoCasa" min="0" max="20000" step="100" value="2000">
          </div>

          <div class="calc-field">
            <label>
              Batteria di accumulo (kWh)
              <span class="tip-i" title="La batteria non crea energia: ti aiuta a spostare l‚Äôenergia del giorno verso sera/notte. Pi√π √® grande, pi√π aumenta l‚Äôenergia che riesci a usare in casa (fino al limite dei tuoi consumi).">‚ìò</span>
            </label>
            <select id="pvBatteria">
              <option value="0">0 (nessuna)</option>
              <option value="5">5 kWh</option>
              <option value="7.5" selected>7,5 kWh</option>
              <option value="10">10 kWh</option>
              <option value="12.5">12,5 kWh</option>
              <option value="15">15 kWh</option>
            </select>
            <div class="tiny-help">Consiglio Syncras: se vuoi ‚Äúsentire‚Äù davvero il FV anche di sera, spesso <strong>7,5 kWh</strong> √® un taglio sensato (poi dipende da consumi e abitudini).</div>
          </div>

          <!-- Avanzati (in Precisa) -->
          <div class="calc-field adv">
            <label>
              Prezzo energia (‚Ç¨/kWh)
              <span class="tip-i" title="Inserisci un prezzo 'tutto incluso' medio in bolletta.">‚ìò</span>
            </label>
            <input type="number" id="pvPrezzo" min="0.05" max="1" step="0.01" value="0.30">
          </div>

          <div class="calc-field adv">
            <label>Costo impianto (‚Ç¨)</label>
            <input type="number" id="pvCosto" min="0" max="40000" step="100" value="10000">
          </div>

          <div class="calc-field adv">
            <label>
              Sistema
              <span class="tip-i" title="ON-GRID: la quota non usata viene ceduta (stima via prezzo cessione). OFF-GRID: nessuna cessione.">‚ìò</span>
            </label>
            <select id="pvTipoImpianto">
              <option value="offgrid">OFF-GRID (nessuna cessione)</option>
              <option value="ongrid" selected>ON-GRID (Scambio / Ritiro)</option>
            </select>
          </div>

          <div class="calc-field adv" id="fieldCessione">
            <label>
              Prezzo cessione energia (‚Ç¨/kWh)
              <span class="tip-i" title="Stima media: valori reali variano in base a periodo e contratto.">‚ìò</span>
            </label>
            <input type="number" id="pvPrezzoCessione" min="0" max="0.5" step="0.01" value="0.10">
          </div>

          <div class="calc-field adv">
            <label>Anni di incentivo / detrazione</label>
            <input type="number" id="pvAnniDetrazione" min="0" max="20" value="10">
          </div>

          <div class="calc-field adv">
            <label>Quota costo detraibile (%)</label>
            <input type="number" id="pvQuotaDetrazione" min="0" max="100" value="50">
          </div>
        </div>

        <button class="calc-button" type="button" onclick="calcolaFotovoltaicoImpianto()">
          Calcola impianto fotovoltaico
        </button>

        <div id="pvResultImpianto" class="calc-result"></div>

        <!-- ‚Äúconti in colonna‚Äù -->
        <div id="pvSchoolSum" class="school-sum hidden" aria-label="Conti in colonna"></div>

        <!-- didascalia ‚Äúumana‚Äù, al posto delle formule -->
        <div class="caption-box">
          <strong>Nota importante (senza panico):</strong> la produzione reale pu√≤ cambiare molto per <strong>orientamento (Nord/Sud)</strong>, <strong>inclinazione</strong> e <strong>ombre</strong>.
          I valori per zona (Nord/Centro/Sud) sono <em>medie</em>. Se vuoi precisione vera, chiedi al tecnico la stima su base impianto e tetto.
        </div>

        <div class="calc-note" style="margin-top:10px;">
          Nota: ON-GRID = la quota non autoconsumata pu√≤ essere ceduta (stimata col prezzo di cessione). OFF-GRID = nessuna cessione.
        </div>

        <!-- Condividi / Copia risultato -->
        <div class="share-row">
          <button class="copy-btn" type="button" onclick="copyPvSummary()">üìã Copia risultato (WhatsApp)</button>
          <span class="tiny-help" id="copyHint">Dopo il calcolo, qui puoi copiare un testo gi√† pronto da incollare.</span>
        </div>
      </div>

      <!-- BLOCCO B (pi√π leggero) -->
      <div class="pv-subsection" style="margin-top:16px;">
        <h3>Blocco B ‚Äì Se hai (o avrai) un‚Äôauto elettrica</h3>
        <p style="font-size:0.85rem; margin-top:0;">
          Questo blocco √® volutamente semplice: serve a stimare quanta energia FV riesci davvero a ‚Äúspostare‚Äù sull‚Äôauto.
          Se oggi spendi tanto in carburante, il vantaggio economico di passare parte dei km su energia pu√≤ essere pi√π forte.
        </p>

        <div class="pv-grid">
          <div class="calc-field">
            <label>Km annui con l‚Äôauto elettrica</label>
            <input type="number" id="evKm" min="0" max="60000" step="500" value="12000">
          </div>

          <div class="calc-field">
            <label>
              Consumo auto (kWh/100 km)
              <span class="tip-i" title="Valori tipici: 13‚Äì20 kWh/100 km (dipende da auto, velocit√†, clima).">‚ìò</span>
            </label>
            <input type="number" id="evConsumo" min="0" max="30" step="0.5" value="16">
          </div>

          <div class="calc-field">
            <label>% ricarica che vorresti fare da fotovoltaico</label>
            <input type="number" id="evQuotaPv" min="0" max="100" value="50">
          </div>

          <div class="calc-field adv">
            <label>Prezzo energia (‚Ç¨/kWh)</label>
            <input type="number" id="evPrezzo" min="0.05" max="1" step="0.01" value="0.30">
          </div>
        </div>

        <button class="calc-button" type="button" onclick="calcolaFotovoltaicoAuto()">
          Calcola impatto auto elettrica
        </button>

        <div id="pvResultAuto" class="calc-result"></div>

        <p class="calc-note">
          Spunta qui sotto se vuoi includere anche l‚Äôauto nella tabella di ammortamento (Blocco C).
        </p>

        <label style="font-size:0.85rem;">
          <input type="checkbox" id="includeAutoInAmort" checked>
          Includi l‚Äôauto elettrica nella tabella di rientro.
        </label>
      </div>

      <!-- BLOCCO C -->
      <div class="pv-subsection" style="margin-top:20px;">
        <h3>Blocco C ‚Äì Tabella di ammortamento anno per anno</h3>

        <p style="font-size:0.9rem; margin-top:0;">
          La tabella usa:
          <strong>beneficio FV</strong> (risparmio bolletta + ricavo cessione) +
          (eventuale) <strong>risparmio auto</strong> +
          <strong>detrazioni</strong>.
        </p>

        <div class="calc-note">
          Suggerimento: orizzonte <strong>15‚Äì20 anni</strong>.
        </div>

        <div class="calc-field" style="margin-top:10px; max-width:220px;">
          <label>Orizzonte di calcolo (anni)</label>
          <input type="number" id="amortYears" min="5" max="30" value="20">
        </div>

        <button class="calc-button" type="button" onclick="calcolaAmmortamento()">
          Genera tabella di ammortamento
        </button>

        <button class="print-btn" type="button" onclick="window.print()">
          üñ®Ô∏è Stampa o salva in PDF
        </button>

        <div class="headline hidden" id="headlineResult"></div>
        <div id="pvResultAmort" class="calc-result"></div>

        <div class="whatif-box hidden" id="whatIfBox">
          <h4>Cosa cambia davvero se‚Ä¶</h4>
          <ul id="whatIfList"></ul>
          <div class="tiny-help">Sono micro-simulazioni veloci (non previsione). Servono per capire ‚Äúcosa pesa di pi√π‚Äù.</div>
        </div>
      </div>

      <div class="amazon-box">
        <strong>Consiglio SmartShop:</strong>
        Confronta almeno <strong>2‚Äì3 preventivi reali</strong>. Il calcolatore serve a capire gli ordini di grandezza.
      </div>
    </section>

    <!-- Richiami -->
    <section style="margin-top:30px; padding:16px; border-radius:10px; background:#F7F7FB; border:1px solid #E5E7EB;">
      <h2 style="margin-top:0;">Ti possono interessare anche:</h2>

      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:10px;">
        <article style="background:#FFFFFF; border-radius:8px; padding:10px 12px; border:1px solid #E5E7EB;">
          <a href="https://syncras.app/calcolatore-consumi-auto.html" style="text-decoration:none; color:var(--violet-dark); display:block;">
            <h3 style="margin-top:0; font-size:1rem;">Quanto costa davvero usare un‚Äôauto?</h3>
            <p style="font-size:0.9rem; margin:0;">Confronta i costi reali per km: termico vs elettrico.</p>
          </a>
        </article>

        <article style="background:#FFFFFF; border-radius:8px; padding:10px 12px; border:1px solid #E5E7EB;">
          <a href="https://syncras.app/smart-test/smart-test-auto-elettrica-per-te.html" style="text-decoration:none; color:var(--violet-dark); display:block;">
            <h3 style="margin-top:0; font-size:1rem;">Ha senso l‚Äôauto elettrica per te?</h3>
            <p style="font-size:0.9rem; margin:0;">Test rapido basato sul tuo uso reale.</p>
          </a>
        </article>

        <article style="background:#FFFFFF; border-radius:8px; padding:10px 12px; border:1px solid #E5E7EB;">
          <a href="https://syncras.app/smart-test/smart-test-ibrida-plugin-o-nessuna.html" style="text-decoration:none; color:var(--violet-dark); display:block;">
            <h3 style="margin-top:0; font-size:1rem;">Ibrida, plug-in o nessuna?</h3>
            <p style="font-size:0.9rem; margin:0;">Capisci cosa conviene davvero, senza marketing.</p>
          </a>
        </article>
      </div>

      <div style="text-align:center; margin-top:18px;">
        <button id="shareBottom" class="share-btn">
          <span class="icon">üìé</span> Condividi questa pagina
        </button>
      </div>
    </section>
  </main>

  <footer class="syncras-footer">
    <div class="footer-inner">
      <div class="footer-column">
        <h4>Syncras.App</h4>
        <p>
          Metodo SmartShop per fare acquisti con la testa (e con un po‚Äô di ironia).<br>
          Niente tecnicismi inutili, solo esperienze reali e numeri spiegati semplice.
        </p>
      </div>

      <div class="footer-column">
        <h4>Link utili</h4>
        <ul>
          <li><a href="blog.html">Tutte le guide SmartShop</a></li>
          <li><a href="calcolatori.html">Tutti i calcolatori</a></li>
          <li><a href="fotovoltaico-4-kw-con-accumulo-10-kwh-quanto-costa-davvero-nel-2025.html">Caso reale fotovoltaico</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h4>Legale &amp; Privacy</h4>
        <ul>
          <li><a href="privacy.html">Privacy Policy</a></li>
          <li><a href="cookie.html">Cookie Policy</a></li>
          <li><a href="disclaimer-amazon.html">Disclaimer Amazon</a></li>
          <li><a href="note-legali.html">Note Legali</a></li>
          <li><a href="#" id="cookie-settings">Impostazioni cookie</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>¬© <span id="year-span"></span> Syncras.App ‚Äî Tutti i diritti riservati.</p>
      <p>
        Syncras.App partecipa al Programma Affiliazione Amazon EU.
        Acquistando tramite i link presenti nelle pagine, il sito pu√≤ ricevere una piccola commissione
        senza alcun costo aggiuntivo per l‚Äôutente.
      </p>
      <p>
        Per ordini, resi, spedizioni o dati relativi agli acquisti, √® necessario rivolgersi
        direttamente al servizio clienti Amazon tramite il proprio account.
      </p>
    </div>
  </footer>

  <!-- Cookie Banner (consenso preventivo: GA solo dopo accettazione) -->
  <div id="cookie-banner" role="dialog" aria-label="Banner cookie">
    <p>
      Usiamo cookie tecnici e dati anonimi per migliorare il sito e misurare le visite (Google Analytics).
      Alcuni link potrebbero essere di affiliazione.
      Per dettagli leggi la <a href="cookie.html">Cookie Policy</a> e la <a href="privacy.html">Privacy Policy</a>.
    </p>
    <div class="btn-row">
      <button type="button" class="reject" onclick="rejectCookies()">Rifiuta</button>
      <button type="button" class="accept" onclick="acceptCookies()">Accetta e continua</button>
    </div>
  </div>

  <script>
    // ===== UI =====
    function toggleMenu(){ document.body.classList.toggle('nav-open'); }

    function sharePage(){
      const url = window.location.href;
      const title = 'Calcolatore fotovoltaico con ammortamento | Syncras.App';
      if (navigator.share) {
        navigator.share({ title, url }).catch(() => {});
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          alert('Link copiato negli appunti. Puoi incollarlo dove vuoi.');
        }).catch(() => {
          alert('Non sono riuscito a copiare il link, ma puoi usare la barra degli indirizzi.');
        });
      } else {
        alert('Condivisione non supportata: copia il link dalla barra degli indirizzi.');
      }
    }

    function euro0(val){
      const n = Number(val) || 0;
      return n.toFixed(0).replace('.', ',');
    }
    function euro2(val){
      const n = Number(val) || 0;
      return n.toFixed(2).replace('.', ',');
    }

    function checkLegalAccept(){
      const cb = document.getElementById('legalAccept');
      if (cb && !cb.checked) {
        alert('Per usare questo calcolatore devi dichiarare di aver letto e accettato le Note Legali.');
        return false;
      }
      return true;
    }

    // ===== Batteria ‚Üí stima autoconsumo (%) (euristica semplice, non ‚Äúmagica‚Äù) =====
    // Nota: poi si limita comunque a: min(consumo casa, produzione * %)
    const SC_BY_BATTERY = [
      { b: 0,   sc: 0.30 },  // senza batteria: spesso 20‚Äì40%
      { b: 5,   sc: 0.45 },
      { b: 7.5, sc: 0.55 },
      { b: 10,  sc: 0.62 },
      { b: 12.5,sc: 0.68 },
      { b: 15,  sc: 0.72 }
    ];

    function getScFromBattery(b){
      const x = Number(b) || 0;
      // match pi√π vicino tra i valori disponibili
      let best = SC_BY_BATTERY[0];
      for (const p of SC_BY_BATTERY){
        if (Math.abs(p.b - x) < Math.abs(best.b - x)) best = p;
      }
      return best.sc;
    }

    // ===== Modalit√† rapida/precisa =====
    const QUICK_PRESET = {
      pvPrezzo: 0.30,
      pvTipoImpianto: "ongrid",
      pvPrezzoCessione: 0.10,
      pvAnniDetrazione: 10,
      pvQuotaDetrazione: 50,
      evPrezzo: 0.30
    };

    function setMode(isPrecise){
      const modePrecise = document.getElementById('modePrecise');
      const modeQuick = document.getElementById('modeQuick');

      const advFields = document.querySelectorAll('.adv');

      if (isPrecise){
        modePrecise.classList.add('active');
        modeQuick.classList.remove('active');
        advFields.forEach(el => el.classList.remove('hidden'));
        document.getElementById('modeHelp').textContent =
          'Modalit√† Precisa: puoi personalizzare prezzi, on-grid/off-grid e detrazioni.';
      } else {
        modeQuick.classList.add('active');
        modePrecise.classList.remove('active');

        // preset rapidi
        document.getElementById('pvPrezzo').value = QUICK_PRESET.pvPrezzo;
        document.getElementById('pvTipoImpianto').value = QUICK_PRESET.pvTipoImpianto;
        document.getElementById('pvPrezzoCessione').value = QUICK_PRESET.pvPrezzoCessione;
        document.getElementById('pvAnniDetrazione').value = QUICK_PRESET.pvAnniDetrazione;
        document.getElementById('pvQuotaDetrazione').value = QUICK_PRESET.pvQuotaDetrazione;
        document.getElementById('evPrezzo').value = QUICK_PRESET.evPrezzo;

        // nascondi avanzati (restano, ma non confondono)
        advFields.forEach(el => el.classList.add('hidden'));
        document.getElementById('modeHelp').textContent =
          'Modalit√† Rapida: compila solo Potenza, Zona, Consumo casa, Batteria. Il resto usa valori medi (0,30 ‚Ç¨/kWh, cessione 0,10, detrazione 50% in 10 anni, ON-GRID).';
      }
      syncCessioneUI();
    }

    // ===== EV helper =====
    function computeEv(){
      const km = parseFloat(document.getElementById('evKm').value) || 0;
      const consumo100 = parseFloat(document.getElementById('evConsumo').value) || 0;
      const quotaPvPerc = parseFloat(document.getElementById('evQuotaPv').value) || 0;
      const prezzoEv = parseFloat(document.getElementById('evPrezzo').value) || 0;

      const warnings = [];
      if (consumo100 > 22) warnings.push('Consumo auto molto alto: controlla kWh/100km (tipico 13‚Äì20).');
      if (km >= 60000) warnings.push('60.000 km/anno √® un uso intenso: ok come stress-test, ma attenzione al realismo.');

      if (km <= 0 || consumo100 <= 0) {
        return { ok:false, kWhAnnuiAuto:0, autoPvKWhWanted:0, prezzoEv, warnings };
      }

      const kWhAnnuiAuto = km * (consumo100 / 100);
      const autoPvKWhWanted = kWhAnnuiAuto * (quotaPvPerc / 100);
      return { ok:true, kWhAnnuiAuto, autoPvKWhWanted, prezzoEv, warnings };
    }

    // ===== FV base =====
    function computeFotovoltaicoBase(autoPvKWhWanted){
      const kw = parseFloat(document.getElementById('pvKw').value) || 0;
      const prodPerKw = parseFloat(document.getElementById('pvZona').value) || 0;
      const consumoCasa = parseFloat(document.getElementById('pvConsumoCasa').value) || 0;

      const batteria = parseFloat(document.getElementById('pvBatteria').value) || 0;
      const scPerc = getScFromBattery(batteria); // 0..1

      const prezzo = parseFloat(document.getElementById('pvPrezzo').value) || 0;
      const costoImpianto = parseFloat(document.getElementById('pvCosto').value) || 0;

      const tipoImpianto = document.getElementById('pvTipoImpianto').value;
      const prezzoCessione = parseFloat(document.getElementById('pvPrezzoCessione').value) || 0;

      const anniDetr = parseFloat(document.getElementById('pvAnniDetrazione').value) || 0;
      const quotaDetrPerc = parseFloat(document.getElementById('pvQuotaDetrazione').value) || 0;

      if (kw <= 0 || prodPerKw <= 0) return { ok:false, error:'Inserisci almeno potenza impianto e zona.' };

      const produzioneAnnua = kw * prodPerKw;

      // Potenziale ‚Äútrattenibile‚Äù in casa stimato da batteria ‚Üí poi limitato dai consumi reali
      const autoconsumoPotenziale = produzioneAnnua * scPerc;
      const autoconsumoCasaKWh = Math.min(autoconsumoPotenziale, consumoCasa);

      const fvResiduoDopoCasa = Math.max(produzioneAnnua - autoconsumoCasaKWh, 0);

      // Auto: pu√≤ prendere FV solo dal residuo dopo casa
      const autoWanted = Math.max(0, Number(autoPvKWhWanted) || 0);
      const autoPvEffettivoKWh = Math.min(autoWanted, fvResiduoDopoCasa);

      // Cessione: ci√≤ che resta dopo casa + auto (se ON-GRID)
      let energiaCedutaKWh = 0;
      let ricavoCessione = 0;
      if (tipoImpianto === 'ongrid') {
        energiaCedutaKWh = Math.max(produzioneAnnua - autoconsumoCasaKWh - autoPvEffettivoKWh, 0);
        ricavoCessione = energiaCedutaKWh * prezzoCessione;
      }

      const risparmioAutoconsumoCasa = autoconsumoCasaKWh * prezzo;
      const beneficioAnnualeFV = risparmioAutoconsumoCasa + ricavoCessione;

      const detrazioneTotale = (costoImpianto > 0) ? (costoImpianto * (quotaDetrPerc / 100)) : 0;
      const detrazioneAnnua = (anniDetr > 0) ? (detrazioneTotale / anniDetr) : 0;

      return {
        ok:true,
        kw, prodPerKw, consumoCasa, batteria, scPerc, prezzo, costoImpianto,
        tipoImpianto, prezzoCessione,
        anniDetr, quotaDetrPerc,
        produzioneAnnua,
        autoconsumoPotenziale,
        autoconsumoCasaKWh,
        fvResiduoDopoCasa,
        autoPvEffettivoKWh,
        autoPvKWhWanted: autoWanted,
        energiaCedutaKWh,
        risparmioAutoconsumoCasa,
        ricavoCessione,
        beneficioAnnualeFV,
        detrazioneTotale,
        detrazioneAnnua
      };
    }

    // ===== Coerenza: semaforo =====
    function setCoherence(status, items){
      const badge = document.getElementById('coherenceBadge');
      const list = document.getElementById('coherenceList');

      badge.classList.remove('badge-ok','badge-warn','badge-bad');
      if (status === 'ok') { badge.classList.add('badge-ok'); badge.textContent = '‚úÖ OK'; }
      if (status === 'warn') { badge.classList.add('badge-warn'); badge.textContent = '‚ö†Ô∏è Attenzione'; }
      if (status === 'bad') { badge.classList.add('badge-bad'); badge.textContent = '‚õî Incoerente'; }

      list.innerHTML = '';
      (items || []).forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        list.appendChild(li);
      });
    }

    function coherenceCheck(r, evInfo){
      const issuesBad = [];
      const issuesWarn = [];

      if (!r || !r.ok) {
        setCoherence('warn', ['Inserisci i dati e premi ‚ÄúCalcola impianto‚Äù.']);
        return;
      }

      if ((r.consumoCasa || 0) <= 0) issuesWarn.push('Consumo casa = 0: l‚Äôenergia ‚Äútenuta in casa‚Äù andr√† a 0 ‚Üí risultato poco realistico.');
      if ((r.prezzo || 0) < 0.10) issuesWarn.push('Prezzo energia molto basso: forse non √® ‚Äútutto incluso‚Äù.');
      if ((r.prezzo || 0) > 0.60) issuesWarn.push('Prezzo energia molto alto: ok se includi periodi critici, ma verifica.');
      if (r.tipoImpianto === 'ongrid' && (r.prezzoCessione || 0) <= 0) issuesWarn.push('ON-GRID ma prezzo cessione = 0: la cessione non dar√† ricavo.');

      // auto check
      if (evInfo && evInfo.ok){
        if (evInfo.warnings && evInfo.warnings.length) issuesWarn.push(...evInfo.warnings);
        if (r.autoPvKWhWanted > r.fvResiduoDopoCasa) {
          issuesWarn.push(`Auto: richiedi ${r.autoPvKWhWanted.toFixed(0)} kWh FV/anno ma dopo i consumi casa restano ${r.fvResiduoDopoCasa.toFixed(0)} kWh ‚Üí il calcolo limiter√† l‚Äôauto a ${r.autoPvEffettivoKWh.toFixed(0)} kWh.`);
        }
      }

      if (r.autoconsumoCasaKWh > r.produzioneAnnua + 1e-6) issuesBad.push('Energia trattenuta in casa > produzione: impossibile (controlla i dati).');
      if (r.produzioneAnnua <= 0) issuesBad.push('Produzione annua nulla: controlla potenza e zona.');

      if (issuesBad.length){
        setCoherence('bad', issuesBad.concat(issuesWarn));
      } else if (issuesWarn.length){
        setCoherence('warn', issuesWarn);
      } else {
        setCoherence('ok', ['Dati coerenti. Ora puoi generare anche la tabella di ammortamento.']);
      }
    }

    // ===== BLOCCO A =====
    function renderSchoolSum(r){
      const box = document.getElementById('pvSchoolSum');
      if (!box) return;

      const total = (r.risparmioAutoconsumoCasa + r.ricavoCessione);

      box.innerHTML = `
        <div class="title">Conti ‚Äúcome a scuola‚Äù</div>
        <div class="sum-grid">
          <div class="label">Risparmio bolletta (energia usata in casa)</div>
          <div class="val">${euro0(r.risparmioAutoconsumoCasa)} ‚Ç¨</div>

          <div class="label">Ricavo cessione (energia venduta)</div>
          <div class="val">${euro0(r.ricavoCessione)} ‚Ç¨</div>

          <div class="sum-line"></div>

          <div class="label sum-total">Totale beneficio FV annuo</div>
          <div class="val sum-total">${euro0(total)} ‚Ç¨</div>
        </div>
      `;
      box.classList.remove('hidden');
    }

    function calcolaFotovoltaicoImpianto(){
      if (!checkLegalAccept()) return;

      const r = computeFotovoltaicoBase(0);
      if (!r.ok){ alert(r.error || 'Dati non validi.'); return; }

      coherenceCheck(r, null);

      const rientroSoloBeneficio = (r.costoImpianto > 0 && r.beneficioAnnualeFV > 0)
        ? (r.costoImpianto / r.beneficioAnnualeFV) : null;

      const rientroConDetrazioni = (r.costoImpianto > 0 && (r.beneficioAnnualeFV + r.detrazioneAnnua) > 0)
        ? (r.costoImpianto / (r.beneficioAnnualeFV + r.detrazioneAnnua)) : null;

      const div = document.getElementById('pvResultImpianto');
      div.style.display = 'block';

      const scPercNice = Math.round((r.scPerc || 0) * 100);

      div.innerHTML = `
        <strong>Produzione annua:</strong> ${r.produzioneAnnua.toFixed(0)} kWh/anno<br>
        ‚Ä¢ Batteria: <strong>${(r.batteria || 0).toString().replace('.', ',')} kWh</strong> ‚Üí stima ‚Äúenergia trattenuta‚Äù ‚âà <strong>${scPercNice}%</strong> (poi limitata dai tuoi consumi)<br>
        ‚Ä¢ Energia usata in casa (limitata dai consumi casa): <strong>${r.autoconsumoCasaKWh.toFixed(0)} kWh/anno</strong><br>
        ‚Ä¢ Risparmio bolletta: <strong>${euro0(r.risparmioAutoconsumoCasa)} ‚Ç¨</strong><br>
        ${
          r.tipoImpianto === 'ongrid'
            ? `‚Ä¢ Energia ceduta: <strong>${r.energiaCedutaKWh.toFixed(0)} kWh/anno</strong><br>
            `
‚Ä¢ Ricavo cessione (@${euro2(r.prezzoCessione)} ‚Ç¨/kWh): <strong>${euro(r.ricavoCessione)} ‚Ç¨</strong><br>
‚Ä¢ Beneficio annuo FV totale (casa + cessione): <strong>${euro(r.beneficioAnnualeFV)} ‚Ç¨</strong><br>

            : `‚Ä¢ Impianto OFF-GRID: <strong>nessuna cessione</strong><br>`
        }
        ‚Ä¢ Beneficio FV annuo totale (bolletta + cessione): <strong>${euro0(r.beneficioAnnualeFV)} ‚Ç¨</strong><br>
        ${r.detrazioneTotale > 0 ? `‚Ä¢ Detrazione ipotetica: <strong>${euro0(r.detrazioneTotale)} ‚Ç¨</strong> (‚âà ${euro0(r.detrazioneAnnua)} ‚Ç¨/anno)<br>` : ''}
        ‚Ä¢ Rientro solo con beneficio annuo: <strong>${rientroSoloBeneficio ? rientroSoloBeneficio.toFixed(1) : '---'} anni</strong><br>
        ‚Ä¢ Rientro con detrazioni: <strong>${rientroConDetrazioni ? rientroConDetrazioni.toFixed(1) : '---'} anni</strong><br>
        <span style="font-size:0.8rem; color:#4b5563;">
          Nota: Scambio sul Posto / Ritiro Dedicato sono stimati tramite il prezzo di cessione impostato.
        </span>
      `;

      renderSchoolSum(r);
      window.__lastPv = { blockA: r, blockB: null, summaryText: buildPvShareText(r, null) };
      const hint = document.getElementById('copyHint');
      if (hint) hint.textContent = 'Pronto: clicca ‚ÄúCopia risultato (WhatsApp)‚Äù e incolla dove vuoi.';
    }

    // ===== BLOCCO B =====
    function calcolaFotovoltaicoAuto(){
      if (!checkLegalAccept()) return;

      const ev = computeEv();
      if (!ev.ok) { alert('Inserisci almeno km annui e consumo auto.'); return; }

      const r = computeFotovoltaicoBase(ev.autoPvKWhWanted);
      if (!r.ok){ alert(r.error || 'Dati impianto non validi nel Blocco A.'); return; }

      coherenceCheck(r, ev);

      const div = document.getElementById('pvResultAuto');
      div.style.display = 'block';

      const risparmioAutoReale = r.autoPvEffettivoKWh * (ev.prezzoEv || 0);

      const extraWarn = (ev.autoPvKWhWanted > r.fvResiduoDopoCasa)
        ? `<div style="margin-top:8px; padding:8px 10px; border-radius:8px; background:#fff7ed; border:1px solid #fed7aa;">
             ‚ö†Ô∏è <strong>Limite reale:</strong> vorresti ${ev.autoPvKWhWanted.toFixed(0)} kWh FV/anno per l‚Äôauto, ma dopo i consumi casa restano ${r.fvResiduoDopoCasa.toFixed(0)}.
             Quindi l‚Äôauto potr√† usare <strong>al massimo ${r.autoPvEffettivoKWh.toFixed(0)} kWh/anno</strong> dal FV (il resto viene dalla rete).
           </div>`
        : '';

      div.innerHTML = `
        <strong>Consumo annuo auto elettrica:</strong> ${ev.kWhAnnuiAuto.toFixed(0)} kWh/anno<br>
        ‚Ä¢ Quota desiderata da FV: <strong>${ev.autoPvKWhWanted.toFixed(0)} kWh/anno</strong><br>
        ‚Ä¢ FV effettivamente disponibile per auto (dopo casa): <strong>${r.autoPvEffettivoKWh.toFixed(0)} kWh/anno</strong><br>
        ‚Ä¢ ‚ÄúValore economico‚Äù del FV usato sull‚Äôauto (stima): <strong>${euro0(risparmioAutoReale)} ‚Ç¨</strong><br>
        <span style="font-size:0.8rem; color:#4b5563;">
          Nota: questo valore riguarda solo i kWh davvero prodotti e usati dal FV.
        </span>
        ${extraWarn}
      `;

      window.__lastPv = { blockA: r, blockB: { ev, risparmioAutoReale }, summaryText: buildPvShareText(r, { ev, risparmioAutoReale }) };
      const hint = document.getElementById('copyHint');
      if (hint) hint.textContent = 'Aggiornato con Auto: ora la copia include anche la parte auto.';
    }

    // ===== BLOCCO C - AMMORTAMENTO =====
    function calcolaAmmortamento() {
      if (!checkLegalAccept()) return;

      const includeAuto = document.getElementById('includeAutoInAmort').checked;
      const ev = includeAuto ? computeEv() : { ok:false, autoPvKWhWanted:0, prezzoEv:0, warnings:[] };

      const r = computeFotovoltaicoBase(includeAuto && ev.ok ? ev.autoPvKWhWanted : 0);
      if (!r.ok) { alert('Dati impianto non validi nel Blocco A.'); return; }

      coherenceCheck(r, includeAuto ? ev : null);

      const anniOrizzonte = parseInt(document.getElementById('amortYears').value) || 20;

      const risparmioAnnualeAuto = (includeAuto && ev.ok) ? (r.autoPvEffettivoKWh * (ev.prezzoEv || 0)) : 0;

      const head = document.getElementById('headlineResult');
      const div = document.getElementById('pvResultAmort');
      div.style.display = 'block';

      let html = `
        <strong>Riepilogo parametri usati:</strong><br>
        ‚Ä¢ Costo impianto: <strong>${euro0(r.costoImpianto)} ‚Ç¨</strong><br>
        ‚Ä¢ Produzione: <strong>${r.produzioneAnnua.toFixed(0)} kWh/anno</strong><br>
        ‚Ä¢ Energia usata in casa: <strong>${r.autoconsumoCasaKWh.toFixed(0)} kWh/anno</strong><br>
        ‚Ä¢ FV usato per auto (effettivo): <strong>${r.autoPvEffettivoKWh.toFixed(0)} kWh/anno</strong><br>
        ${
          r.tipoImpianto === 'ongrid'
          ? `‚Ä¢ Energia ceduta (dopo casa+auto): <strong>${r.energiaCedutaKWh.toFixed(0)} kWh/anno</strong><br>
             ‚Ä¢ Ricavo cessione: <strong>${euro0(r.ricavoCessione)} ‚Ç¨</strong> (@${euro2(r.prezzoCessione)} ‚Ç¨/kWh)<br>`
          : `‚Ä¢ Impianto OFF-GRID: <strong>nessuna cessione</strong><br>`
        }
        ‚Ä¢ Beneficio FV (bolletta + cessione): <strong>${euro0(r.beneficioAnnualeFV)} ‚Ç¨</strong><br>
        ‚Ä¢ Beneficio auto (solo FV effettivo): <strong>${euro0(risparmioAnnualeAuto)} ‚Ç¨</strong><br>
        ${r.detrazioneAnnua > 0
          ? `‚Ä¢ Detrazioni: <strong>${euro0(r.detrazioneAnnua)} ‚Ç¨/anno</strong> per ${r.anniDetr.toFixed(0)} anni (totale ‚âà ${euro0(r.detrazioneTotale)} ‚Ç¨)<br>`
          : `‚Ä¢ Detrazioni: <strong>non considerate</strong><br>`
        }
        ‚Ä¢ Orizzonte: <strong>${anniOrizzonte} anni</strong><br>
      `;

      let cumulativo = -r.costoImpianto;
      let breakEvenAnno = -1;

      let table = `
        <div class="amort-wrapper">
          <table class="amort-table">
            <thead>
              <tr>
                <th>Anno</th>
                <th>Beneficio FV (bolletta+cess.)</th>
                ${includeAuto ? '<th>Beneficio Auto (FV)</th>' : ''}
                <th>Detrazione</th>
                <th>Totale anno</th>
                <th>Cumulativo</th>
                <th>Capitale residuo</th>
              </tr>
            </thead>
            <tbody>
      `;

      for (let i = 1; i <= anniOrizzonte; i++) {
        const degrado = Math.pow(0.995, i - 1);

        const benefFv = r.beneficioAnnualeFV * degrado;
        const benefAuto = includeAuto ? (risparmioAnnualeAuto * degrado) : 0;
        const detr = (i <= r.anniDetr) ? r.detrazioneAnnua : 0;

        const totale = benefFv + benefAuto + detr;
        cumulativo += totale;

        const capitaleResiduo = Math.max(0, -cumulativo);

        let rowClass = "";
        if (cumulativo >= 0 && breakEvenAnno === -1) {
          breakEvenAnno = i;
          rowClass = "row-break-even";
        }

        table += `
          <tr class="${rowClass}">
            <td>${i}</td>
            <td>${euro0(benefFv)}</td>
            ${includeAuto ? `<td>${euro0(benefAuto)}</td>` : ''}
            <td>${euro0(detr)}</td>
            <td><strong>${euro0(totale)}</strong></td>
            <td style="color:${cumulativo>=0?'var(--ok)':'#b91c1c'}">${euro0(cumulativo)}</td>
            <td>${euro0(capitaleResiduo)} ‚Ç¨</td>
          </tr>
        `;
      }

      table += `</tbody></table></div>
        <div class="amort-legend">
          * La riga verde indica quando il cumulativo supera il costo impianto. <br>
          * Degrado pannelli incluso: 0,5% annuo. Prezzi energia considerati costanti.
        </div>
      `;

      head.classList.remove('hidden');
      if (breakEvenAnno !== -1) {
        head.innerHTML = `<strong>‚úÖ Tempo di rientro stimato: circa ${breakEvenAnno} anni</strong><br>
          <span style="font-size:.9rem;color:#4b5563;">Include detrazioni (se impostate) + beneficio FV/auto.</span>`;
      } else {
        head.innerHTML = `<strong>‚ö†Ô∏è Non si ripaga entro ${anniOrizzonte} anni</strong><br>
          <span style="font-size:.9rem;color:#4b5563;">Prova a rivedere batteria, prezzo energia o costo impianto.</span>`;
      }

      div.innerHTML = html + table;

      buildWhatIf(r, risparmioAnnualeAuto, anniOrizzonte);
    }

    // ===== What-if (semplice) =====
    function buildWhatIf(r, risparmioAnnualeAuto, anniOrizzonte){
      const box = document.getElementById('whatIfBox');
      const list = document.getElementById('whatIfList');
      list.innerHTML = '';

      if (!r || !r.ok || r.costoImpianto <= 0){
        box.classList.add('hidden');
        return;
      }

      function estimatePayback(benefFV, benefAuto, detrAnnua, detrYears){
        let cumul = -r.costoImpianto;
        for (let i=1; i<=anniOrizzonte; i++){
          const degrado = Math.pow(0.995, i - 1);
          const detr = (i <= detrYears) ? detrAnnua : 0;
          cumul += (benefFV*degrado) + (benefAuto*degrado) + detr;
          if (cumul >= 0) return i;
        }
        return null;
      }

      const base = estimatePayback(r.beneficioAnnualeFV, risparmioAnnualeAuto, r.detrazioneAnnua, r.anniDetr);

      // scenario: prezzo energia +0,10
      const prezzo2 = r.prezzo + 0.10;
      const benefFV_price = (r.autoconsumoCasaKWh * prezzo2) + r.ricavoCessione;
      const pb2 = estimatePayback(benefFV_price, risparmioAnnualeAuto, r.detrazioneAnnua, r.anniDetr);

      // scenario: prezzo cessione -0,04
      const cessionePrice2 = Math.max(0, r.prezzoCessione - 0.04);
      const benefFV_ced = (r.autoconsumoCasaKWh * r.prezzo) + (r.energiaCedutaKWh * cessionePrice2);
      const pb3 = estimatePayback(benefFV_ced, risparmioAnnualeAuto, r.detrazioneAnnua, r.anniDetr);

      // scenario: batteria +1 taglio (se possibile)
      const opts = [0,5,7.5,10,12.5,15];
      const idx = Math.max(0, opts.indexOf(Number(r.batteria)));
      const nextB = opts[Math.min(opts.length-1, idx+1)];
      const sc2 = getScFromBattery(nextB);
      const autocPot2 = r.produzioneAnnua * sc2;
      const autocReale2 = Math.min(autocPot2, r.consumoCasa);
      const rispCasa2 = autocReale2 * r.prezzo;
      const energiaCeduta2 = (r.tipoImpianto==='ongrid')
        ? Math.max(r.produzioneAnnua - autocReale2 - r.autoPvEffettivoKWh, 0) : 0;
      const ricavo2 = energiaCeduta2 * r.prezzoCessione;
      const benefFV2 = rispCasa2 + ricavo2;
      const pb1 = estimatePayback(benefFV2, risparmioAnnualeAuto, r.detrazioneAnnua, r.anniDetr);

      function li(text){
        const el = document.createElement('li');
        el.textContent = text;
        list.appendChild(el);
      }

      li(base === null ? 'Base: non si ripaga entro l‚Äôorizzonte selezionato.' : `Base: rientro ~${base} anni.`);
      li(`Se prezzo energia sale a ${euro2(prezzo2)} ‚Ç¨/kWh ‚Üí rientro ${pb2 ? ('~'+pb2+' anni') : 'non entro orizzonte'}.`);
      li(`Se prezzo cessione scende a ${euro2(cessionePrice2)} ‚Ç¨/kWh ‚Üí rientro ${pb3 ? ('~'+pb3+' anni') : 'non entro orizzonte'}.`);
      li(`Se passi a batteria ${nextB.toString().replace('.', ',')} kWh ‚Üí rientro ${pb1 ? ('~'+pb1+' anni') : 'non entro orizzonte'}.`);

      box.classList.remove('hidden');
    }

    // ===== ON/OFF grid UX =====
    function syncCessioneUI(){
      const tipo = document.getElementById('pvTipoImpianto');
      const inpCessione = document.getElementById('pvPrezzoCessione');
      const wrap = document.getElementById('fieldCessione');

      const ongrid = (tipo.value === 'ongrid');
      inpCessione.disabled = !ongrid;
      inpCessione.style.opacity = ongrid ? '1' : '0.6';
      wrap.style.opacity = ongrid ? '1' : '0.6';
    }

    // ===== Viral: testo pronto da copiare =====
    function buildPvShareText(r, b){
      if (!r || !r.ok) return 'Calcolatore FV Syncras: inserisci i dati e fai ‚ÄúCalcola impianto‚Äù.';

      const url = window.location.href;
      const scPercNice = Math.round((r.scPerc || 0) * 100);

      // stima rientro ‚Äúveloce‚Äù
      const payNoDet = (r.costoImpianto > 0 && r.beneficioAnnualeFV > 0) ? (r.costoImpianto / r.beneficioAnnualeFV) : null;
      const payWithDet = (r.costoImpianto > 0 && (r.beneficioAnnualeFV + r.detrazioneAnnua) > 0)
        ? (r.costoImpianto / (r.beneficioAnnualeFV + r.detrazioneAnnua)) : null;

      let lines = [];
      lines.push(`‚òÄÔ∏è FV Syncras (stima)`);
      lines.push(`Impianto: ${r.kw} kW | Zona: ${r.prodPerKw} kWh/kW | Casa: ${r.consumoCasa} kWh/anno`);
      lines.push(`Batteria: ${(r.batteria||0).toString().replace('.',',')} kWh (stima trattenuta ~${scPercNice}%, limitata dai consumi)`);
      lines.push(`Produzione: ${r.produzioneAnnua.toFixed(0)} kWh/anno`);
      lines.push(`Usata in casa: ${r.autoconsumoCasaKWh.toFixed(0)} kWh/anno ‚Üí Risparmio ~${euro0(r.risparmioAutoconsumoCasa)} ‚Ç¨`);
      if (r.tipoImpianto === 'ongrid'){
        lines.push(`Ceduta: ${r.energiaCedutaKWh.toFixed(0)} kWh/anno ‚Üí Ricavo ~${euro0(r.ricavoCessione)} ‚Ç¨`);
      } else {
        lines.push(`OFF-GRID: nessuna cessione`);
      }
      lines.push(`Totale beneficio FV annuo: ~${euro0(r.beneficioAnnualeFV)} ‚Ç¨`);

      if (b && b.ev && b.ev.ok){
        lines.push(`Auto EV: FV usato sull‚Äôauto ~${r.autoPvEffettivoKWh.toFixed(0)} kWh/anno ‚Üí valore ~${euro0(b.risparmioAutoReale)} ‚Ç¨`);
      }

      if (payNoDet) lines.push(`Rientro (solo beneficio): ~${payNoDet.toFixed(1)} anni`);
      if (payWithDet && r.detrazioneAnnua > 0) lines.push(`Rientro (con detrazioni): ~${payWithDet.toFixed(1)} anni`);

      lines.push(`üîó ${url}`);
      return lines.join('\n');
    }

    function copyPvSummary(){
      const txt = (window.__lastPv && window.__lastPv.summaryText)
        ? window.__lastPv.summaryText
        : 'Calcolatore FV Syncras: fai ‚ÄúCalcola impianto‚Äù e poi copia qui il testo pronto.';

      if (navigator.clipboard) {
        navigator.clipboard.writeText(txt).then(() => {
          alert('Testo copiato! Ora incollalo su WhatsApp / Telegram / dove vuoi.');
        }).catch(() => {
          alert('Non sono riuscito a copiare. Seleziona e copia manualmente dalla pagina.');
        });
      } else {
        alert('Clipboard non supportata: puoi condividere col pulsante ‚ÄúCondividi questa pagina‚Äù.');
      }
    }

    // ======== GDPR COOKIE + GA (consenso preventivo) ========
    (function(){
      const GA_ID = 'G-CFTTCYDZ2P';
      const CONSENT_KEY = 'syncras_cookie_consent';

      // blocca GA preventivamente
      window['ga-disable-' + GA_ID] = true;

      function loadGoogleAnalytics(){
        if (window.__syncrasGaLoaded) return;
        window.__syncrasGaLoaded = true;

        // riabilita GA SOLO dopo consenso
        window['ga-disable-' + GA_ID] = false;

        const gaScript = document.createElement('script');
        gaScript.async = true;
        gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
        document.head.appendChild(gaScript);

        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        window.gtag = gtag;

        gtag('js', new Date());
        gtag('config', GA_ID, { anonymize_ip: true });
      }

      function showBanner(){
        const b = document.getElementById('cookie-banner');
        if (b) b.style.display = 'block';
      }
      function hideBanner(){
        const b = document.getElementById('cookie-banner');
        if (b) b.style.display = 'none';
      }

      window.acceptCookies = function(){
        localStorage.setItem(CONSENT_KEY, 'yes');
        hideBanner();
        loadGoogleAnalytics();
      };

      window.rejectCookies = function(){
        localStorage.setItem(CONSENT_KEY, 'no');
        hideBanner();
        window['ga-disable-' + GA_ID] = true;
      };

      window.revokeCookies = function(){
        localStorage.removeItem(CONSENT_KEY);
        window['ga-disable-' + GA_ID] = true;
        showBanner();
      };

      document.addEventListener('DOMContentLoaded', function(){
        const consent = localStorage.getItem(CONSENT_KEY);
        if (consent === 'yes') loadGoogleAnalytics();
        else if (consent === 'no') window['ga-disable-' + GA_ID] = true;
        else showBanner();
      });
    })();

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function(){
      // year
      const y = document.getElementById('year-span');
      if (y) y.textContent = new Date().getFullYear();

      // share buttons
      const top = document.getElementById('shareTop');
      const bottom = document.getElementById('shareBottom');
      if (top) top.addEventListener('click', sharePage);
      if (bottom) bottom.addEventListener('click', sharePage);

      // cookie settings (revoca)
      const cs = document.getElementById('cookie-settings');
      if (cs) cs.addEventListener('click', function(e){
        e.preventDefault();
        if (typeof window.revokeCookies === 'function') window.revokeCookies();
      });

      // ON/OFF grid UI
      const tipo = document.getElementById('pvTipoImpianto');
      if (tipo) {
        tipo.addEventListener('change', syncCessioneUI);
        syncCessioneUI();
      }

      // mode toggles
      const mP = document.getElementById('modePrecise');
      const mQ = document.getElementById('modeQuick');

      if (mP && mQ){
        mQ.addEventListener('click', () => setMode(false));
        mP.addEventListener('click', () => setMode(true));
        mQ.addEventListener('keydown', (e)=>{ if(e.key==='Enter') setMode(false); });
        mP.addEventListener('keydown', (e)=>{ if(e.key==='Enter') setMode(true); });
      }

      // default: RAPIDA (come volevi tu)
      setMode(false);

      // initial coherence
      setCoherence('warn', ['Inserisci i dati e premi ‚ÄúCalcola impianto‚Äù.']);
    });
  </script>
</body>
</html>


